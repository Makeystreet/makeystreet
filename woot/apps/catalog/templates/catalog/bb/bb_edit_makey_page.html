<script>
var False = false;
var True = true;
app.can_edit = {{can_edit|safe}};
app.defaultMakeyStatus = "Completed";

app.User = Backbone.Tastypie.Model.extend({
    urlRoot : "/api/v1/user/",
    idAttribute : "id",
    url : function() {
        if(this.get("id") === undefined) {
            return this.urlRoot;
        } else {
            return this.urlRoot + this.get("id") + "/";
        }
    },
});

app.initializeUser = function() {
    var cur_fb_user = app.cur_fb_user;
    if(cur_fb_user === undefined) {
        if(!cur_user_details.id) {
            // $('#login_modal').modal('show');
            return;
        }
        cur_fb_user = new app.User({'id' : cur_user_details.id});
        cur_fb_user = cur_fb_user.fetch({
            success : function(model, response) {
                app.cur_fb_user = response;
            },
        });

        if(cur_user_details.id) {
            user_id = cur_user_details.id;
        } else {
            user_id = -1;
        }
        mixpanel.track("MakeyP: Event", {event_type: "makey_page_opened", user_id:user_id, makey_id:{{makey_id}}});
    }
};
app.initializeUser();

app.Collaborator = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/user/',
    idAttribute : 'id',

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        if(this.get('resource_uri') !== undefined) {
            this.fetch();
        }
    },
});

app.CollaboratorList = Backbone.Tastypie.Collection.extend({
    model : app.Collaborator,
    urlRoot : '/api/v1/user/',

    url : function() {
        return this.urlRoot;
    },
});

app.Part = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/product_m/',
    idAttribute : 'id',

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        // if(cur_user_details.id !== undefined && this.get('resource_uri') !== undefined) {
        if(this.get('resource_uri') !== undefined) {
            this.fetch();
        }
    },
});

app.PartList = Backbone.Tastypie.Collection.extend({
    model : app.Part,
    urlRoot : '/api/v1/product_m/',

    url : function() {
        return this.urlRoot;
    },
});

app.NewUser = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/new_user/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        if(this.get('resource_uri') !== undefined) {
            this.fetch();
        }
    },
});

app.NewUserList = Backbone.Tastypie.Collection.extend({
    model : app.NewUser,
    urlRoot : '/api/v1/new_user/',

    url : function() {
        return this.urlRoot;
    },
});

app.NoteLike = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/likes/note/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },
});

app.NoteLikeList = Backbone.Tastypie.Collection.extend({
    model : app.NoteLike,
    urlRoot : '/api/v1/likes/note/',

    url : function() {
        if(cur_user_details.id === undefined)
            return;

        if(this.curUserLikes) {
            return this.urlRoot + "?limit=1&note=" + this.noteId + "&liker=" + cur_user_details.id;
        }
        return this.urlRoot + "?limit=2&note=" + this.noteId;
    },

    initialize : function(options) {
        if(cur_user_details.id === undefined) {
            return;
        }

        options || (options = {});

        if(options.noteId) {
            this.noteId = options.noteId;
        }

        if(options.curUserLikes) {
            this.curUserLikes = options.curUserLikes;
        }
    },
});

app.Note = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/note/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
        'cur_user_likes' : false,
        'like_id' : 0,
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        this.comments = new app.CommentList();

        this.on('change:comments', function(model, response){
            this.comments.reset();
            for(var i=0; i<this.get('comments').length; i++) {
                this.comments.add({'resource_uri' : this.get('comments')[i]});
            }
        });

        if(this.get('resource_uri') !== undefined) {
            var noteId = this.get('resource_uri').replace(this.urlRoot,'').replace('/','');
            this.noteId = noteId;

            if(cur_user_details.id !== undefined){
                this.fetchCurUserLikes();
            } else {
                this.fetch({
                    success: function (model, response, options) {
                        model.startTracking();
                    }
                });
            }
        }
    },

    fetchCurUserLikes : function() {
        this.curUserLikes = new app.NoteLikeList({noteId : this.noteId, curUserLikes : true});

        var that = this;
        this.curUserLikes.fetch({
            success : function(collection, response) {
                if(collection.meta.total_count > 0) {
                    that.set({
                        'cur_user_likes' : true,
                        'like_id' : collection.models[0].get('id'),
                    });
                } else {
                    that.set({
                        'cur_user_likes' : false,
                        'like_id' : 0,
                    });
                }
                that.fetch({
                    success: function (model, response, options) {
                        model.startTracking();
                    }
                });
            },
        });
    },
});

app.NoteList = Backbone.Tastypie.Collection.extend({
    model : app.Note,
    urlRoot : '/api/v1/note/',
    comparator: 'order',

    url : function() {
        return this.urlRoot;
    },
});

app.TextDocumentation = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/text_documentation/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now'
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        if(this.get('resource_uri') !== undefined) {
            this.fetch();
        }
    },
});

app.TextDocumentationList = Backbone.Tastypie.Collection.extend({
    model : app.TextDocumentation,
    urlRoot : '/api/v1/text_documentation/',
    comparator: 'order',

    url : function() {
        return this.urlRoot;
    },
});

app.Step = Backbone.Tastypie.Model.extend({
    urlRoot: '/api/v1/step/',
    idAttribute: 'id',

    defaults: {
        'added_time': 'Now',
    },

    url: function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize: function() {
        if(this.get('resource_uri') !== undefined) {
            this.fetch();
        }
    },
});

app.StepList = Backbone.Tastypie.Collection.extend({
    model: app.Step,
    urlRoot: '/api/v1/step/',
    comparator: 'order',

    url: function() {
        return this.urlRoot;
    },
});

app.Documentation = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/documentation/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        // if(cur_user_details.id !== undefined && this.get('resource_uri') !== undefined) {
        if(this.get('resource_uri') !== undefined) {
            this.fetch();
        }
    },
});

app.DocumentationList = Backbone.Tastypie.Collection.extend({
    model : app.Documentation,
    urlRoot : '/api/v1/documentation',
    comparator: 'order',

    url : function() {
        return this.urlRoot;
    },
});

app.CommentLike = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/likes/comment/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },
});

app.CommentLikeList = Backbone.Tastypie.Collection.extend({
    model : app.CommentLike,
    urlRoot : '/api/v1/likes/comment/',

    url : function() {
        if(cur_user_details.id === undefined)
            return;

        if(this.curUserLikes) {
            return this.urlRoot + "?limit=1&comment=" + this.commentId + "&liker=" + cur_user_details.id;
        }
        return this.urlRoot + "?limit=2&comment=" + this.commentId;
    },

    initialize : function(options) {
        if(cur_user_details.id === undefined) {
            return;
        }

        options || (options = {});

        if(options.commentId) {
            this.commentId = options.commentId;
        }

        if(options.curUserLikes) {
            this.curUserLikes = options.curUserLikes;
        }
    },
});

app.Comment = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/comment/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
        'cur_user_likes' : false,
        'like_id' : 0,
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        if(this.get('resource_uri') !== undefined) {
            var commentId = this.get('resource_uri').replace(this.urlRoot,'').replace('/','');
            this.commentId = commentId;

            if(cur_user_details.id !== undefined){
                this.fetchCurUserLikes();
            } else {
                this.fetch({
                    success: function (model, response, options) {
                        model.startTracking();
                    }
                });
            }
        }
    },

    fetchCurUserLikes : function() {
        this.curUserLikes = new app.CommentLikeList({commentId : this.commentId, curUserLikes : true});

        var that = this;
        this.curUserLikes.fetch({
            success : function(collection, response) {
                if(collection.meta.total_count > 0) {
                    that.set({
                        'cur_user_likes' : true,
                        'like_id' : collection.models[0].get('id'),
                    });
                } else {
                    that.set({
                        'cur_user_likes' : false,
                        'like_id' : 0,
                    });
                }
                that.fetch({
                    success: function (model, response, options) {
                        model.startTracking();
                    }
                });
            },
        });
    },
});

app.CommentList = Backbone.Tastypie.Collection.extend({
    model : app.Comment,
    urlRoot : '/api/v1/comment/',

    url : function() {
        return this.urlRoot;
    },
});

app.ImageLike = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/likes/image/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },
});

app.ImageLikeList = Backbone.Tastypie.Collection.extend({
    model : app.ImageLike,
    urlRoot : '/api/v1/likes/image/',

    url : function() {
        if(cur_user_details.id === undefined)
            return;

        if(this.curUserLikes) {
            return this.urlRoot + "?limit=1&image=" + this.imageId + "&liker=" + cur_user_details.id;
        }
        return this.urlRoot + "?limit=2&image=" + this.imageId;
    },

    initialize : function(options) {
        if(cur_user_details.id === undefined) {
            return;
        }

        options || (options = {});

        if(options.imageId) {
            this.imageId = options.imageId;
        }

        if(options.curUserLikes) {
            this.curUserLikes = options.curUserLikes;
        }
    },
});

app.Image = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/image/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
        'cur_user_likes' : false,
        'like_id' : 0,
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        this.comments = new app.CommentList();

        if(this.get('resource_uri') !== undefined) {
            var imageId = this.get('resource_uri').replace(this.urlRoot,'').replace('/','');
            this.imageId = imageId;

            if(cur_user_details.id !== undefined){
                this.fetchCurUserLikes();
            } else {
                this.fetch({
                    success: function (model, response, options) {
                        model.startTracking();
                    }
                });
            }
        }

        this.on('change:comments', function(model, response){
            this.comments.reset();
            for(var i=0; i<this.get('comments').length; i++) {
                this.comments.add({'resource_uri' : this.get('comments')[i]});
            }
        });
    },

    fetchCurUserLikes : function() {
        this.curUserLikes = new app.ImageLikeList({imageId : this.imageId, curUserLikes : true});

        var that = this;
        this.curUserLikes.fetch({
            success : function(collection, response) {
                if(collection.meta.total_count > 0) {
                    that.set({
                        'cur_user_likes' : true,
                        'like_id' : collection.models[0].get('id'),
                    });
                } else {
                    that.set({
                        'cur_user_likes' : false,
                        'like_id' : 0,
                    });
                }
                that.fetch({
                    success: function (model, response, options) {
                        model.startTracking();
                    }
                });
            },
        });
    },
});

app.ImageList = Backbone.Tastypie.Collection.extend({
    model : app.Image,
    urlRoot : '/api/v1/image/',

    comparator : function(model) {
        return model.get('order');
    },

    url : function() {
        return this.urlRoot;
    },
});

app.VideoLike = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/likes/video/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },
});

app.VideoLikeList = Backbone.Tastypie.Collection.extend({
    model : app.VideoLike,
    urlRoot : '/api/v1/likes/video/',

    url : function() {
        if(cur_user_details.id === undefined)
            return;

        if(this.curUserLikes) {
            return this.urlRoot + "?limit=1&video=" + this.videoId + "&liker=" + cur_user_details.id;
        }
        return this.urlRoot + "?limit=2&video=" + this.videoId;
    },

    initialize : function(options) {
        if(cur_user_details.id === undefined) {
            return;
        }

        options || (options = {});

        if(options.videoId) {
            this.videoId = options.videoId;
        }

        if(options.curUserLikes) {
            this.curUserLikes = options.curUserLikes;
        }
    },
});

app.Video = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/video/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
        'cur_user_likes' : false,
        'like_id' : 0,
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        this.comments = new app.CommentList();

        if(this.get('resource_uri') !== undefined) {
            var videoId = this.get('resource_uri').replace(this.urlRoot,'').replace('/','');
            this.videoId = videoId;

            if(cur_user_details.id !== undefined){
                this.fetchCurUserLikes();
            } else {
                this.fetch({
                    success: function (model, response, options) {
                        model.startTracking();
                    }
                });
            }
        }

        this.on('change:comments', function(model, response){
            this.comments.reset();
            for(var i=0; i<this.get('comments').length; i++) {
                this.comments.add({'resource_uri' : this.get('comments')[i]});
            }
        });
    },

    fetchCurUserLikes : function() {
        this.curUserLikes = new app.VideoLikeList({videoId : this.videoId, curUserLikes : true});

        var that = this;
        this.curUserLikes.fetch({
            success : function(collection, response) {
                if(collection.meta.total_count > 0) {
                    that.set({
                        'cur_user_likes' : true,
                        'like_id' : collection.models[0].get('id'),
                    });
                } else {
                    that.set({
                        'cur_user_likes' : false,
                        'like_id' : 0,
                    });
                }
                that.fetch({
                    success: function (model, response, options) {
                        model.startTracking();
                    }
                });
            },
        });
    },
});

app.VideoList = Backbone.Tastypie.Collection.extend({
    model : app.Video,
    urlRoot : '/api/v1/video/',

    comparator : function(model) {
        return model.get('order');
    },

    url : function() {
        return this.urlRoot;
    },
});

app.NewPart = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/new_part/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
    },

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        if(this.get('resource_uri') !== undefined) {
            this.fetch();
        }
    },
});

app.NewPartList = Backbone.Tastypie.Collection.extend({
    model : app.NewPart,
    urlRoot : '/api/v1/new_part/',

    url : function() {
        return this.urlRoot;
    },
});

app.SendMail = Backbone.Tastypie.Model.extend({
    urlRoot: '/api/v1/send_mail/',
    idAttribute: 'id',

    url: function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + '/';
        } else {
            return this.urlRoot;
        }
    },
});

app.MakeyBasic = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/top_makeys/',
    idAttribute : 'id',

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + '/';
        } else {
            return this.urlRoot;
        }
    },
    initialize : function(options){
        this.cover_pic = new app.Image();

        if(this.get('cover_pic') !== undefined && this.get('cover_pic') !== null && this.get('cover_pic').added_time === undefined) {
            this.cover_pic.set({'resource_uri' : this.get('cover_pic')});
            var that = this;
            this.cover_pic.fetch({
                success : function(model, response){
                    that.set({'cover_pic_url' : response.large_url });
                },
            });
        } else {
            if (this.attributes.images && this.attributes.images.length>0) {
                this.set({'cover_pic_url': this.attributes.images[0].large_url});
            }
        }

        if(this.get('added_time') === undefined) {
            this.fetch();
        }
    },
});

app.MakeySimilarList = Backbone.Tastypie.Collection.extend({
    model : app.MakeyBasic,
    urlRoot : '/api/v1/top_makeys/',

    url : function() {
        if(this.makeyId != -1) {
            return this.urlRoot + 'similar/' + this.makeyId + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function(options) {
        options || (options = {});

        if(options.makeyId) {
            this.makeyId = options.makeyId;
        } else {
            this.makeyId = -1;
        }

        this.fetch();

    },
});

app.MakeyLike = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/likes/makey/',
    idAttribute : 'id',

    defaults : {
        'added_time' : 'Now',
        'makey' : '/api/v1/makey/{{makey_id}}/',
    },
});

app.MakeyLikeList = Backbone.Tastypie.Collection.extend({
    model : app.MakeyLike,
    idAttribute : 'id',
    urlRoot : '/api/v1/likes/makey/',

    url : function() {
        if(this.allLikes) {
            return this.urlRoot + "?limit=0&makey=" + app.makey.get('id');
        }

        if(this.curUserLikes) {
            return this.urlRoot + "?limit=2&makey=" + app.makey.get('id') + "&liker=" + cur_user_details.id;
        } else {
            return this.urlRoot + "?limit=2&makey=" + app.makey.get('id');
        }
    },

    initialize : function(options) {
        options || (options = {});

        this.curUserLikes = false;
        if(options.curUserLikes) {
            this.curUserLikes = options.curUserLikes;
        }
        if(options.allLikes) {
            this.allLikes = options.allLikes;
        }

        if(!this.allLikes) {
            this.fetch();
        }
    },
});

app.MakeyBasicList = Backbone.Tastypie.Collection.extend({
    model: app.MakeyBasic,
    urlRoot: '/api/v1/top_makeys/',
});

app.File = Backbone.Tastypie.Model.extend({
    urlRoot: '/api/v1/file/',
    idAttribute: 'id',

    defaults: {
        'added_time': 'Now',
    },

    url: function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize: function() {
        if(this.get('resource_uri') !== undefined) {
            this.fetch();
        }
    },
});

app.FileList = Backbone.Tastypie.Collection.extend({
    model: app.File,
    urlRoot: '/api/v1/file/',

    url : function() {
        return this.urlRoot;
    },
});

app.Makey = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/makey/',
    idAttribute : 'id',

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        this.collaborators = new app.CollaboratorList();
        this.on("change:collaborators", function(model, options) {
            this.collaborators.reset();
            for(var i=0; i<this.get('collaborators').length; i++) {
                this.collaborators.add({'resource_uri' : this.get('collaborators')[i]});
            }
        });

        this.modules = new app.MakeyBasicList();
        this.on('change:modules_used', function(model, options) {
            this.modules.reset();
            for(var i=0; i<this.get('modules_used').length; i++) {
                this.modules.add({'resource_uri': this.get('modules_used')[i].replace('makey', 'top_makeys')});
            }
        });

        this.parts = new app.PartList();
        // if(cur_user_details.id !== undefined) {
            this.on("change:parts", function(model, options) {
                this.parts.reset();
                for(var i=0; i<this.get('parts').length; i++) {
                    this.parts.add({'resource_uri' : this.get('parts')[i]});
                }
            });
        // }

        this.new_users = new app.NewUserList();
        this.on("change:new_users", function(model, options){
            this.new_users.reset();
            for(var i=0; i<this.get('new_users').length; i++) {
                this.new_users.add({'resource_uri' : this.get('new_users')[i]});
            }
        });

        this.new_parts = new app.NewPartList();
        this.on("change:new_parts", function(model, options){
            this.new_parts.reset();
            for(var i=0; i<this.get('new_parts').length; i++) {
                this.new_parts.add({'resource_uri' : this.get('new_parts')[i]});
            }
        });

        this.new_tools = new app.NewPartList();
        this.on("change:new_tools", function(model, options){
            this.new_tools.reset();
            for(var i=0; i<this.get('new_tools').length; i++) {
                this.new_tools.add({'resource_uri' : this.get('new_tools')[i]});
            }
        });

        this.tools = new app.PartList();
        // if(cur_user_details.id !== undefined) {
            this.on("change:tools", function(model, options) {
                this.tools.reset();
                for(var i=0; i<this.get('tools').length; i++) {
                    this.tools.add({'resource_uri' : this.get('tools')[i]});
                }
            });
        // }

        this.notes = new app.NoteList();
        this.on("change:notes", function(model, options) {
            this.notes.reset();
            for(var i=0; i<this.get('notes').length; i++) {
                this.notes.add({'resource_uri' : this.get('notes')[i]});
            }
        });

        this.documentations = new app.DocumentationList();
        this.on("change:documentations", function(model, options) {
            this.documentations.reset();
            for(var i=0; i<this.get('documentations').length; i++) {
                this.documentations.add({'resource_uri' : this.get('documentations')[i]});
            }
        });

        this.textdocs = new app.TextDocumentationList();
        this.on("change:text_documentations", function(model, options) {
            this.textdocs.reset();
            for(var i=0; i<this.get('text_documentations').length; i++) {
                this.textdocs.add({'resource_uri' : this.get('text_documentations')[i]});
            }
        });

        this.steps = new app.StepList();
        this.on("change:steps", function(model, options) {
            this.steps.reset();
            for(var i=0; i<this.get('steps').length; i++) {
                this.steps.add({'resource_uri': this.get('steps')[i]});
            }
        });

        this.comments = new app.CommentList();
        this.on("change:comments", function(model, options) {
            this.comments.reset();
            for(var i=0; i<this.get('comments').length; i++) {
                this.comments.add({'resource_uri' : this.get('comments')[i]});
            }
        });

        this.images = new app.ImageList();
        this.on("change:images", function(model, options) {
            this.images.reset();
            for(var i=0; i<this.get('images').length; i++) {
                this.images.add({'resource_uri' : this.get('images')[i]});
            }
        });

        this.videos = new app.VideoList();
        this.on("change:videos", function(model, options) {
            this.videos.reset();
            for(var i=0; i<this.get('videos').length; i++) {
                this.videos.add({'resource_uri' : this.get('videos')[i]});
            }
        });

        this.tags = new app.TagList();
        this.on("change:tags", function(model, options) {
            this.tags.reset();
            for(var i=0; i<this.get('tags').length; i++) {
                this.tags.add(this.get('tags')[i]);
            }
        });

        this.files = new app.FileList();
        this.on('change:files', function(model, options) {
            this.files.reset();
            for(var i=0; i<this.get('files').length; i++) {
                this.files.add({'resource_uri': this.get('files')[i]});
            }
        });

        this.similar = new app.MakeySimilarList({makeyId : this.get('id')});
    },
});

app.MakeyAboutView = Backbone.View.extend({
    el : $('#about'),
    template : Handlebars.compile($('#makey_about_template').html()),

    events : {
        "click #save_edit_about" : "updateAbout",
        "click #close_about_modal" : "removeSavedMessage",
        "keyup #edit_about" : "updateAboutLength",
    },

    initialize : function() {
        this.listenTo(app.makey, 'change:about', this.add);
        this.listenTo(app.makey, 'change:about', this.updateAboutLength);

        this.$('#edit_about_modal').on('shown.bs.modal', function(){
            $('#edit_about').focus();
        });
    },

    add : function() {
        this.$('#makey_about').html('');
        this.$('#makey_about').append(this.template({'makey_about' : app.makey.get('about')}));

        this.$('#edit_about').html('');
        this.$('#edit_about').append(app.makey.get('about'));
    },

    updateAbout : function() {
        var about = this.$('#edit_about')[0].value;
        app.makey.set({'about' : about});

        var that = this;
        this.$('#success_about').hide();
        this.$('#waiting_about').show();
        app.makey.save(app.makey.unsavedAttributes(), {
            patch : true,
            success : function(model, response) {
                that.$('#waiting_about').hide();
                that.$('#success_about').show();

                mixpanel.track("MakeyP: Event", {event_type: "makey_about_edited", user_id:cur_user_details.id, makey_id:{{makey_id}}});

                that.$("#edit_about_modal").modal('hide');
            },
        });
    },

    removeSavedMessage : function() {
        this.$('#waiting_about').hide();
        this.$('#success_about').hide();
    },

    updateAboutLength : function() {
        if(!app.can_edit) {
            return;
        }

        var about_len = this.$('#edit_about').val().length;
        this.$('#chars_length').html(200-about_len);

        this.$('#chars_about').removeClass();
        this.$('#chars_about').addClass('alert');
        if(about_len < 150) {
            this.$('#chars_about').addClass('alert-info');
        } else if (about_len >= 150 && about_len < 180) {
            this.$('#chars_about').addClass('alert-warning');
        } else {
            this.$('#chars_about').addClass('alert-danger');
        }
    }
});

app.MakeyDocumentationView = Backbone.View.extend({
    el : $('#how-to'),
    template : Handlebars.compile($('#makey_documentation_template').html()),
    template_edit : Handlebars.compile($('#makey_documentation_edit_template').html()),
    login_template : Handlebars.compile($('#documentation_login_template').html()),

    events : {
        'click #save_add_docu' : 'addNewDocu',
        'click .remove_docu' : 'removeDocu',
        'click #close_add_docu_modal' : 'removeSavedMessage',
        'click .docu':'docuClick',
    },

    initialize : function() {
        this.listenTo(app.makey.documentations, 'change', this.addAll);
        this.listenTo(app.makey.documentations, 'add', this.addAll);
        this.listenTo(app.makey.documentations, 'remove', this.addAll);

        this.addAll()
    },

    addAll : function() {
        this.$('#makey_documentation').html('');
        this.$('#edit_makey_documentation').html('');
        if (app.makey.documentations.length>0 )
            $('.show_how').show();
        app.makey.documentations.each(this.add, this);

        $('#a_documentations').find('span').html(app.makey.documentations.models.length);
        $('.how_no').html(app.makey.documentations.models.length);

        // if(app.makey.documentations.models.length == 0) {
        //     this.$el.hide();
        // }
    },

    add : function(model) {
        var json = model.toJSON();

        var a = document.createElement('a');
        a.href = json.url;
        json.domain_name = a.hostname;

        this.$('#makey_documentation').append(this.template(json));
        this.$('#edit_makey_documentation').append(this.template_edit(json));
    },

    removeSavedMessage : function() {
        this.$('#success_docu_change').hide();
        this.$('#success_add_docu').hide();
    },

    addNewDocu : function() {
        var url_regex = /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_]*)?\??(?:[\-\+=&;%@\.\w_]*)#?(?:[\.\!\/\\\w]*))?)/;
        var url = $('#docu_url').val();

        if(!url_regex.test(url)) {
            $('#failed_add_docu').show();
            return;
        }
        this.$('#failed_add_docu').hide();
        this.$('#error_add_docu').hide();

        if(url.substring(4,0) != "http") {
            url = "http://" + url;
        }

        var docu = new app.Documentation({'url' : url});

        var that = this;
        this.$('#success_add_docu').hide();
        this.$('#waiting_add_docu').show();
        docu.save(null, {
            success : function(model, response) {
                that.$('#waiting_add_docu').hide();
                that.$('#success_add_docu').show();
                app.makey.documentations.add(model);
                app.makey.get('documentations').push(model.get('resource_uri'));
                app.makey.save({
                    'documentations': app.makey.get('documentations'),
                }, {
                    patch: true,
                });

                that.$('#docu_url').val('');

                mixpanel.track("MakeyP: Event", {event_type: "makey_docu_created", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 docu_id: model.get('id')});
            },
            error : function(model, response) {
                that.$('#waiting_add_docu').hide();
                that.$('#error_add_docu').show();

                that.$('#docu_url').val('');
            },
        });
    },

    removeDocu : function() {
        if(!confirm("Are you sure you want to delete this?")) {
            return;
        }

        var that = this;
        this.$('#success_docu_change').hide();
        this.$('#waiting_docu_change').show();

        var docu_id = parseInt(event.target.id.substring(5));
        var docu = app.makey.documentations.get(docu_id);

        docu.save({'is_enabled': false}, {
            success: function(){
                var index = app.makey.get('documentations').indexOf(docu.get('resource_uri'));
                app.makey.get('documentations').splice(index, 1);

                app.makey.save({
                    'documentations': app.makey.get('documentations'),
                }, {
                    patch : true,
                    success : function(model, response) {
                        that.$('#waiting_docu_change').hide();
                        that.$('#success_docu_change').show();

                        mixpanel.track("MakeyP: Event", {
                            event_type: "makey_docu_deleted",
                            user_id: cur_user_details.id,
                            makey_id: {{makey_id}},
                            docu_id: docu_id
                        });
                    },
                });
            },
        });

        app.makey.documentations.remove(docu);
        this.$('#docu_'+docu_id).remove();
    },

    docuClick:function(){
        var doc_id = parseInt(event.target.id.substring(5));
        doc = app.makey.documentations.get(doc_id);
        var position = app.makey.documentations.indexOf(doc);
        if (app.cur_fb_user)
        {
            var user_name=app.cur_fb_user.first_name
            var user_id=app.cur_fb_user.id
        }

        if(cur_user_details.id) {
            user_id = cur_user_details.id;
        } else {
            user_id = -1;
        }
        mixpanel.track("MakeyP: Detail docs clicked", {doc_id:doc_id,position:position,user_id:user_id,user_name:user_name});
    },
});

app.MakeyDocumentationViewV2 = Backbone.View.extend({
    el : $('#how-to'),
    template : Handlebars.compile($('#makey_documentation_v2_template').html()),
    template_edit : Handlebars.compile($('#makey_documentation_v2_edit_template').html()),
    template_empty : Handlebars.compile($('#makey_documentation_v2_empty_template').html()),

    events : {
        'click .btn-edit-select-url': 'editDocURL',
        'click .btn-edit-select-title': 'editDocTitle',
        'click .btn-edit-url-save': 'editDocUrlSave',
        'click .btn-edit-url-cancel': 'editDocReset',
        'click .btn-edit-title-save': 'editDocSaveTitle',
        'click .btn-edit-title-cancel': 'editDocReset',
        'click .btn-delete-confirm': 'removeDoc',
        'click .btn-add-save-url': 'addDocUrl',
        'click #btn-add-title-cancel': 'resetAddDoc',
        'click #btn-add-title-add': 'addDocTitleUrl',
    },

    initialize : function() {
        this.listenTo(app.makey.documentations, 'change', this.render);
        this.listenTo(app.makey.documentations, 'add', this.render);
        this.listenTo(app.makey.documentations, 'remove', this.render);

        this.render();
    },

    render : function() {
        this.$('#makey_documentation').html('');

        app.makey.documentations.sort();
        this.addAll();

        $('#a_documentations').find('span').html(app.makey.documentations.models.length);
        $('.how_no').html(app.makey.documentations.models.length);

        if(app.makey.documentations.models.length > 1) {
            var that = this;
            this.$('#makey_documentation').sortable({
                handle: ".handle",
                opacity: 0.5,
                update: function(event, ui) {
                   var idArr = $(this).sortable('toArray');
                   var cleanedIdArr = [];
                   for(var i=0; i<idArr.length; ++i) {
                        cleanedIdArr.push(idArr[i].substring(5));
                   }
                   that.updateDocuOrder(cleanedIdArr);
                }
            });
        }

        this.delegateEvents();

    },

    addAll: function() {
        if(app.makey.documentations.models.length) {
            app.makey.documentations.each(this.add, this);
        }
        else {
            this.$('#makey_documentation').html(this.template_empty());
        }

    },

    add : function(model) {
        var json = model.toJSON();

        var a = document.createElement('a');
        a.href = json.url;
        json.domain_name = a.hostname;
        if(app.makey.documentations.models.length > 1)
            json.sortable = true;

        this.$('#makey_documentation').append(this.template(json));
        this.$('#edit_makey_documentation').append(this.template_edit(json));
        this.$('.tooltips').tooltip();
    },

    updateDocuOrder: function(idArr) {
        for (var i = 0; i < idArr.length; i++) {
            var currDoc = app.makey.documentations.get(idArr[i]);
            currDoc.set({'order' : i});
            currDoc.save(currDoc.unsavedAttributes(), {
                patch : true,
            });
        };
    },

    editDocTitle: function(e) {
        var $docEl = $(e.target).parents("li.docu_entry");
        var docId = $docEl.attr("id").substring(5);
        var docModel = app.makey.documentations.get(docId);
        $docEl.find("input.edit-doc-input-title").val(docModel.get('title'));

        $docEl.removeClass("edit-url edit-title");
        $docEl.addClass("edit-title");

        $docEl.find("input.edit-doc-input-title").focus();
    },

    editDocURL: function(e) {
        var $docEl = $(e.target).parents("li.docu_entry");
        var docId = $docEl.attr("id").substring(5);
        var docModel = app.makey.documentations.get(docId);
        $docEl.find("input.edit-doc-input-url").val(docModel.get('url'));

        $docEl.removeClass("edit-url edit-title");
        $docEl.addClass("edit-url");

        $docEl.find("input.edit-doc-input-url").focus();
    },

    editDocReset: function(e) {
        var $docEl = $(e.target).parents("li");
        $docEl.removeClass("edit-url edit-title");
    },

    editDocUrlSave: function(e) {
        var $btnEl = $(e.target);
        var $docEl = $btnEl.parents("li.docu_entry");
        var docId = $docEl.attr("id").substring(5);
        var docModel = app.makey.documentations.get(docId);

        var prevUrl = docModel.get('url');
        var newUrl = $docEl.find("input.edit-doc-input-url").val();

        if(newUrl && newUrl !== prevUrl) {
            $btnEl.addClass("disabled");
            $btnEl.html("Saving");
            this.fetchOpenGraph(newUrl, function(data){
                if(data.open_graph.valid) {
                    docModel.save({'url': newUrl}, {
                        patch: true,
                        success: function() {
                            $btnEl.removeClass("disabled");
                            $btnEl.html("Save");
                        }
                    });
                }
            });
        } else {
            this.editDocReset(e);
        }
    },

    editDocSaveTitle: function(e) {
        var $docEl = $(e.target).parents("li.docu_entry");
        var docId = $docEl.attr("id").substring(5);
        var docModel = app.makey.documentations.get(docId);

        var prevTitle = docModel.get('title');
        var newTitle = $docEl.find("input.edit-doc-input-title").val();

        if(newTitle && newTitle !== prevTitle) {
            docModel.save({'title': newTitle}, {
                patch : true,
            });
        } else {
            this.editDocReset(e);
        }
    },

    addDocUrl: function(e) {
        var $btnEl = $(e.target);
        this.addDocUrlVal = this.$('#add-doc-url-input').val();
        if(this.addDocUrlVal) {
            $btnEl.addClass("disabled");
            $btnEl.html("Fetching...");
            this.fetchOpenGraph(this.addDocUrlVal, function(data){
                if(data.open_graph.valid) {
                    this.hideAddDocURLInput();
                    this.showAddDocURLPreview(this.addDocUrlVal);
                    this.showAddDocTitleInput(data.open_graph.title);
                } else {
                    this.resetAddDoc();
                }
                $btnEl.removeClass("disabled");
                $btnEl.html("Add");
            });
        } else {
            this.resetAddDoc();
        }
    },

    showAddDocURLPreview: function(url) {
        this.$('#add-doc-url-preview-text').html(url);
        this.$('#add-doc-url-preview-container').show();
    },

    hideAddDocURLPreview: function() {
        this.$('#add-doc-url-preview-container').hide();
        this.$('#add-doc-url-preview-text').html("");
    },

    resetAddDoc: function(url) {
        this.hideAddDocURLPreview();
        this.hideAddDocTitleInput();
        this.showAddDocURLInput();
        this.addDocUrlVal = undefined;
    },

    hideAddDocURLInput: function() {
        this.$('#add-doc-url-input-group').hide();
        this.$('#add-doc-url-input').val("");
    },

    showAddDocURLInput: function() {
        this.$('#add-doc-url-input').val("");
        this.$('#add-doc-url-input-group').show();
    },

    showAddDocTitleInput: function(openGraphTitle) {
        if(openGraphTitle) {
            this.$('#add-doc-title-input').val(openGraphTitle);
        }
        this.$('#add-doc-title-input-group').show();
    },

    hideAddDocTitleInput: function() {
        this.$('#add-doc-title-input').val("");
        this.$('#add-doc-title-input-group').hide();
    },

    addDocTitleUrl: function() {
        var url = this.addDocUrlVal;
        var title = this.$('#add-doc-title-input').val();

        if(!url || !title) {
            return;
        }

        var newDoc = new app.Documentation({
            'url' : url,
            'title': title,
            'order': app.makey.documentations.models.length
        });

        newDoc.save(null, {
            success : function(model, response) {
                app.makey.documentations.add(model);
                app.makey.get('documentations').push(model.get('resource_uri'));
                app.makey.save({
                    'documentations': app.makey.get('documentations'),
                }, {
                    patch: true,
                });
                mixpanel.track("MakeyP: Event", {event_type: "makey_docu_created", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 docu_id: model.get('id')});
            }
        });

        this.resetAddDoc();
    },

    fetchOpenGraph: function(url, cb) {

        var cleanedURL = url;
        if (!/^https?:\/\//i.test(url)) {
            cleanedURL = 'http://' + url;
        }

        var ogAPIURL = "/api/v1/article/open_graph/?url=" + encodeURIComponent(cleanedURL);
        $.ajax({
            url: ogAPIURL,
            context : this
        }).done(cb);
    },

    removeDoc: function(e) {
        var $docEl = $(e.target).parents("li.docu_entry");
        var docId = $docEl.attr("id").substring(5);
        var docModel = app.makey.documentations.get(docId);

        docModel.save({'is_enabled': false}, {
            patch: true,
            success: function(){
                var index = app.makey.get('documentations').indexOf(docModel.get('resource_uri'));
                app.makey.get('documentations').splice(index, 1);

                app.makey.save({
                    'documentations': app.makey.get('documentations'),
                }, {
                    patch : true,
                    success : function(model, response) {
                        mixpanel.track("MakeyP: Event", {
                            event_type: "makey_docu_deleted",
                            user_id: cur_user_details.id,
                            makey_id: {{makey_id}},
                            docu_id: docId
                        });
                    },
                });
            },
        });

        app.makey.documentations.remove(docModel);
    },
});

app.MakeyCollaboratorsView = Backbone.View.extend({
    el : $('#collaborators'),
    template : Handlebars.compile($('#makey_collaborator_template').html()),
    template_new_user : Handlebars.compile($('#makey_new_user_template').html()),
    pager_template : Handlebars.compile($('#makey_user_table_template').html()),
    pager_template_new_user : Handlebars.compile($('#makey_new_user_table_template').html()),
    user_suggestion_template : Handlebars.compile($('#makey_user_suggestion_template').html()),
    user_popover_template : Handlebars.compile($('#makey_collaborator_popover').html()),
    add_new_collab_template : Handlebars.compile($('#makey_new_collab_template').html()),
    table_heading : Handlebars.compile($('#makey_user_table_heading').html()),

    events : {
        'keyup #new_collaborator' : 'suggestNewUsers',

        'click .user' : 'userClick',
        'click #add_new_collab' : 'newEmailCheck',
        'click #save_new_collab' : 'newUserClick',
        'click #cancel_add_new_collab' : 'cancelNewUser',

        'click .remove_user' : 'removeUser',
        'click .remove_new_user' : 'removeNewUser',

        'click #close_user_modal' : 'cancelNewUser',
        'click a.collaborator': 'collaboratorClick',

        'mouseover .collaborator' : 'collaboratorHover',
        'mouseout .collaborator' : 'collaboratorHoverOut',
    },

    options : {
        cur_item_count : 0,
        collabs_per_line : 6,
    },

    popoverSettings : {
        trigger : 'manual',
        html : true,
        placement : "top",
        animation : false,
        content : function() {
            return $('#collab_hover_content').html();
        },
        template : '<div class="popover userPopover"><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>',
    },

    initialize : function() {
        this.listenTo(app.makey.collaborators, 'add', this.addAll);
        this.listenTo(app.makey.collaborators, 'remove', this.addAll);
        this.listenTo(app.makey.collaborators, 'change', this.addAll);
        this.listenTo(app.makey.new_users, 'change', this.addAll);
        this.listenTo(app.makey.new_users, 'add', this.addAll);
        this.listenTo(app.makey.new_users, 'remove', this.addAll);

        this.listenTo(app.makey.collaborators, 'reset', this.resetView);
        this.listenTo(app.makey.new_users, 'reset', this.resetView);
    },

    resetView : function() {
        this.$('#makey_collaborators').html('');
        this.$('#final_collaborators_list').html('');
    },

    addAll : function() {
        this.$('#makey_collaborators').html('');
        this.$('#final_collaborators_list').html('');
        this.options.cur_item_count = 0;

        this.$('#final_collaborators_list').append(this.table_heading());
        app.makey.collaborators.each(this.addCollab, this);
        app.makey.new_users.each(this.addNewUser, this);
        this.addNewCollabButton();

        this.$('#makey_collaborators').find('.tooltips').tooltip();
    },

    addCollab : function(model) {
        // alert(this.options.cur_item_count);
        if(this.options.cur_item_count % this.options.collabs_per_line == 0) {
            this.$('#makey_collaborators').append("<div class='row'></div>");
        }
        this.$('#makey_collaborators').find(".row").last().append(this.template(model.toJSON()));
        this.options.cur_item_count++;
        // this.$('#makey_collaborators').append(this.template(model.toJSON()));
        this.$('#final_collaborators_list').append(this.pager_template(model.toJSON()));

        this.fetchPopoverData(model);
        this.initPopover(model);
        return this;
    },

    fetchPopoverData : function(model) {
        var collab_id = model.get('id');
        var collab = app.makerpops.get(collab_id);
        if(collab === undefined) {
            var tempCollab = new app.MakerPop({'id' : collab_id});
            app.makerpops.push(tempCollab);
        }
    },

    initPopover : function(model) {
        var imgId = model.get('id');
        this.$('[imgId="collab_' + imgId + '"]').popover(this.popoverSettings);
    },

    addNewUser : function(model) {
        if(this.options.cur_item_count % this.options.collabs_per_line == 0) {
            this.$('#makey_collaborators').append("<div class='row'></div>");
        }
        this.$('#makey_collaborators').find(".row").last().append(this.template_new_user(model.toJSON()));
        this.options.cur_item_count++;
        // this.$('#makey_collaborators').append(this.template_new_user(model.toJSON()));
        this.$('#final_collaborators_list').append(this.pager_template_new_user(model.toJSON()));
    },

    addNewCollabButton : function() {
        if(app.can_edit) {
            {% load static %}
            var json = {
                'img_url' : "{% static 'images/add_user.png' %}",
            };

            this.$('#makey_collaborators').find(".row").last().append(this.add_new_collab_template(json));
        }
    },

    removeSavedMessage : function() {
        this.$('#success_user_add').hide();
        this.$('#success_new_user_add').hide()
        this.$('#success_user_change').hide()
        this.$('#failed_new_user_add').hide();
        this.$('#error_new_user_email').hide();
    },

    removeUser : function() {
        this.removeSavedMessage();
        if(!confirm("Are you sure you want to remove this user?")) {
            return;
        }

        var user_id = parseInt(event.target.id.substring(5));
        if(user_id == cur_user_details.id && user_id != 1) {
            alert("You can't remove yourself from the Makey!");
            return;
        }

        var that = this;
        this.$('#success_user_change').hide();
        this.$('#waiting_user_change').show();

        var user = app.makey.collaborators.get(user_id);
        var index = app.makey.get('collaborators').indexOf(user.get('resource_uri'));
        app.makey.get('collaborators').splice(index, 1);
        var collabs = app.makey.get('collaborators');

        app.makey.fetch({
            success: function(model, response){
                var removed = model.get('removed_collaborators');
                var current = user.get('resource_uri');
                if(! (current in removed)){
                    removed.push(current);
                }
                app.makey.save({
                    'removed_collaborators': removed,
                }, {
                    success: function(){
                        app.makey.save({
                            'collaborators': collabs,
                        }, {
                            patch : true,
                            success : function(model, response) {
                                that.$('#waiting_user_change').hide();
                                that.$('#success_user_change').show();

                                mixpanel.track("MakeyP: Event", {
                                    event_type: "makey_collab_deleted",
                                    user_id: cur_user_details.id,
                                    makey_id: {{makey_id}},
                                    collab_id: user_id
                                });
                            },
                        });
                    }
                });
            },
        });

        app.makey.collaborators.remove(user);
        this.$('#user_'+user_id).remove();
    },

    removeNewUser : function() {
        this.removeSavedMessage();
        if(!confirm("Are you sure you want to remove this user?")) {
            return;
        }

        var user_id  = parseInt(event.target.id.substring(9));
        var user = app.makey.new_users.get(user_id);
        app.makey.new_users.remove(user);

        var index = app.makey.get('new_users').indexOf(user.get('resource_uri'));
        app.makey.get('new_users').splice(index, 1);

        var that = this;
        this.$('#success_user_change').hide();
        this.$('#waiting_user_change').show();
        app.makey.save({
            'new_users': app.makey.get('new_users'),
        }, {
            patch : true,
            success : function(model, response) {
                that.$('#waiting_user_change').hide();
                that.$('#success_user_change').show();

                mixpanel.track("MakeyP: Event", {event_type: "makey_new_collab_deleted", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 new_collab_id: user_id});
            },
        });

        this.$('#new_user_'+user_id).remove();
    },

    suggestNewUsers : function() {
        this.removeSavedMessage();

        var query = $("#new_collaborator").val();
        if(query == "") {
            $('#collaborators_list').html('');
            return;
        }

        var that = this;
        this.$('#collaborators_list').html('');
        this.$('#loading_suggestions').show();
        $.ajax({
            url: {% url 'catalog:user_autocomplete' %},
            type: "GET",
            data: {'q':query},
        }).done(function(msg) {
            var html = "";
            if(query == "") {
                $("#collaborators_list").html("");
            } else {
                var users = msg.split("##");

                that.$('#loading_suggestions').hide();
                for(var i=0; i<users.length-1; i++) {
                    var cur_user = users[i].split("~~~");
                    var user_id = cur_user[1];
                    var user_name = cur_user[0];
                    if(app.makey.collaborators.get(parseInt(user_id)) !== undefined) {
                        continue;
                    }

                    that.$('#collaborators_list').append(that.user_suggestion_template({
                        'user_id' : user_id,
                        'user_name' : user_name,
                    }));
                }
            }
        });
    },

    userClick : function() {
        this.removeSavedMessage();

        var user_id = parseInt(event.target.id.substring(5));
        if(app.makey.collaborators.get(parseInt(user_id)) !== undefined) {
            return;
        }

        var user_name = $(event.target).text();
        $('#new_collaborator').val('');
        $('#collaborators_list').html('');

        var user = new app.User({'id' : user_id});
        var that = this;
        this.$('#success_user_add').hide();
        this.$('#waiting_user_add').show();
        user.fetch({
            success : function(model, response) {
                that.$('#waiting_user_add').hide();
                that.$('#success_user_add').show();
                that.$('#final_collaborators_list').append(that.pager_template(response));

                app.makey.collaborators.add(model);
                app.makey.get('collaborators').push(model.get('resource_uri'));
                app.makey.save({
                    'collaborators': app.makey.get('collaborators'),
                }, {
                    patch : true,
                });

                mixpanel.track("MakeyP: Event", {event_type: "makey_collab_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 collab_id: user_id});
            },
        });
    },

    newEmailCheck: function() {
        this.removeSavedMessage();
        var new_user_email = $('#new_collaborator').val();

        var email_regex = /^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/;
        if(!email_regex.test(new_user_email)) {
            this.$('#error_new_user_email').show();
            this.$('#new_collaborator').select();
            return;
        }

        $('#user_name_form').show();
        $('#add_new_collab').hide();
    },

    newUserClick : function() {
        this.removeSavedMessage();

        var new_user_name = $('#new_collab_name').val();
        var new_user_email = $('#new_collaborator').val();

        var email_regex = /^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/;
        if(!email_regex.test(new_user_email)) {
            this.$('#error_new_user_email').show();
            this.$('#new_collaborator').select();
            return;
        }

        if(new_user_name == "" || new_user_email == "") {
            this.$('#failed_new_user_add').show();
            if(new_user_name == "") {
                this.$('#new_collab_name').select();
            } else {
                this.$('#new_collaborator').select();
            }
            return;
        }

        var user = new app.NewUser({
            'name' : new_user_name,
            'email' : new_user_email,
        });

        var that = this;
        this.$('#success_new_user_add').hide();
        this.$('#waiting_new_user_add').show();
        user.save(null, {
            success : function(model, response) {
                that.$('#waiting_new_user_add').hide();
                that.$('#success_new_user_add').show();
                that.$('#final_collaborators_list').append(that.pager_template_new_user(response));

                app.makey.new_users.add(model);
                app.makey.get('new_users').push(model.get('resource_uri'));
                app.makey.save({
                    'new_users': app.makey.get('new_users'),
                }, {
                    patch : true,
                });

                mixpanel.track("MakeyP: Event", {event_type: "makey_new_collab_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 new_collab_id: model.get('id')});
            },
        });

        this.$('#new_collab_name').val('');
        this.$('#new_collaborator').val('');
        this.$('#user_name_form').hide();
        this.$('#add_new_collab').show();
    },

    cancelNewUser : function() {
        this.removeSavedMessage();
        this.$('#new_collab_name').val('');
        this.$('#new_collaborator').val('');
        this.$('#user_name_form').hide();
        this.$('#add_new_collab').show();
    },

    collaboratorClick: function(event){
        // mixpanel log
        var collab_id = parseInt(event.currentTarget.id.substring(7));
        var collab = app.makey.collaborators.get(collab_id);
        var position = app.makey.collaborators.indexOf(collab);

        var user="";
        if (app.cur_fb_user) {
            user=app.cur_fb_user.first_name
        }

        // mixpanel.track("MakeyP: Collaborator clicked", {
        //     collab_id:collab_id,
        //     collab_name:collab.attributes.first_name,
        //     position:position,user:user
        // });

        if(cur_user_details.id) {
            user_id = cur_user_details.id;
        } else {
            user_id = -1;
        }
        mixpanel.track("MakeyP: Event", {event_type: "makey_collab_clicked", user_id:user_id, makey_id:{{makey_id}},
                                         collab_id:collab_id, position:position});
    },

    collaboratorHover : function(event) {
        var collab_id = parseInt(event.currentTarget.id.substring(7));
        var collab = app.makerpops.get(collab_id);
        if(collab === undefined) {
            var tempCollab = new app.MakerPop({'id' : collab_id});
            app.makerpops.push(tempCollab);
            collab = tempCollab;
        }

        var imgId = event.target.getAttribute('imgId');
        var json = collab.toJSON();
        json.makeys_count = collab.makeys.meta.total_count;
        json.tutorials_count = collab.tutorials.meta.total_count;
        json.following_count = collab.profile.get('following').length;
        json.followers_count = collab.profile.get('followers').length;
        this.$('#collab_hover_content')[0].innerHTML = this.user_popover_template(json);
        this.$('[imgId="'+imgId+'"]').popover('show');

        var that = this;
        this.$('[imgId="'+imgId+'"]').siblings('.popover').on('mouseleave', function() {
            that.$('[imgId="'+imgId+'"]').popover('hide');
        });

        // mixpanel.track("MakeyP: Collaborator Hover", {user_id:user_id, collab_id:collab_id, makey_id:app.makey.get('id')});
        if(cur_user_details.id) {
            user_id = cur_user_details.id;
        } else {
            user_id = -1;
        }
        mixpanel.track("MakeyP: Event", {event_type: "makey_collab_hover", user_id:user_id, makey_id:{{makey_id}},
                                         collab_id: collab_id});
    },

    collaboratorHoverOut : function(event) {
        var imgId = event.target.getAttribute('imgId');
        if(!this.$('.popover:hover').length) {
            this.$('[imgId="'+imgId+'"]').popover('hide');
        }
    },
});

app.MakeyPartsView = Backbone.View.extend({
    el : $('#parts'),
    template : Handlebars.compile($('#makey_parts_template').html()),
    module_template: Handlebars.compile($('#makey_module_template').html()),
    template_new_part : Handlebars.compile($('#makey_new_part_template').html()),
    part_suggestion_template : Handlebars.compile($('#makey_part_suggestion_template').html()),
    login_template : Handlebars.compile($('#parts_login_template').html()),
    part_popover_template : Handlebars.compile($('#parts_popover_template').html()),
    modules_pager_template: Handlebars.compile($('#makey_module_pager_template').html()),

    events : {
        'click .part' : 'partClick',
        'click #add_new_part' : 'createNewPart',

        'click #close_part_modal' : 'removeSavedMessage',
        'click .partMixpanel':'partMixpanelClick',

        'mouseover .part' : 'partHover',
        'mouseout .part' : 'partHoverOut',

        'click .add-module-tab-btn': 'showModifyModules',
        'click .add-part-tab-btn': 'showModifyParts',

        'click #search_module': 'searchModule',
        'click #cance_module': 'cancelModule',
        'click #save_module': 'saveModule',
        // 'click .remove_module': 'removeModule',

        'click .part-delete-btn': 'removePart',
        'click .module-delete-btn': 'removeModule',
        'click .new-part-delete-btn': 'removeNewPart',
        'click .add-part-module-v2': 'showAddComponentModal'
    },

    popoverSettings : {
        trigger : 'manual',
        html : true,
        placement : "auto top",
        content : function() {
            return $('#parts_hover_content').html();
        },
    },

    initialize : function() {
        this.listenTo(app.makey.modules, 'add', this.addAll);
        this.listenTo(app.makey.modules, 'change', this.addAll);
        this.listenTo(app.makey.modules, 'remove', this.addAll);
        this.listenTo(app.makey.modules, 'reset', this.resetView);

        this.listenTo(app.makey.parts, 'add', this.addAll);
        this.listenTo(app.makey.parts, 'change', this.addAll);
        this.listenTo(app.makey.parts, 'remove', this.addAll);
        this.listenTo(app.makey.parts, 'reset', this.resetView);

        this.listenTo(app.makey.new_parts, 'change', this.addAll);
        this.listenTo(app.makey.new_parts, 'add', this.addAll);
        this.listenTo(app.makey.new_parts, 'remove', this.addAll);

        this.addAll();

        this.initSearchBoxes();

        this.$('#add_parts_modal').on('shown.bs.modal', function(){
            $('#new_part').focus();
        });
    },

    initSearchBoxes: function() {

        var that = this;
        var products = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
                url: '/api/v1/product/search?q=%QUERY',
                filter: function(list) {
                    return $.map(list.products, function(product) {
                        return { name: product.name, id: product.id };
                        // return filter off stuff if already added
                    });
                },
                ajax: {
                    beforeSend: function() {
                        that.showPartSearchLoading();
                    },
                    complete: function() {
                        that.hidePartSearchLoading();
                    }
                }
            },
            limit: 10
        });
        products.initialize();

        this.$('#new_part').typeahead({
            hint: true,
            highlight: true,
            minLength: 1
        },{
            name: 'products',
            displayKey: 'name',
            source: products.ttAdapter(),
            templates: {
                empty: Handlebars.compile($('#tt-part-suggestion-empty-template').html()),
            }
        });

        var that = this;
        this.$('#new_part').on("typeahead:selected", function(event, selected, dataset){
            that.addPartToMakey(selected.id);
        });

        var makeys = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                remote: {
                    url: '/api/v1/makey/search?q=%QUERY',
                    filter: function(list) {
                        return $.map(list.makeys, function(makey) {
                            return { name: makey.name,
                                     id: makey.id,
                                     user_name: makey.user.first_name + " " + makey.user.last_name };
                        });
                    },
                    ajax: {
                        beforeSend: function() {
                            that.showMakeySearchLoading();
                        },
                        complete: function() {
                            that.hideMakeySearchLoading();
                        }
                    }
                },
                limit: 10
        });
        makeys.initialize();

        this.$('#add_module_input').typeahead({
            hint: true,
            highlight: true,
            minLength: 1
        },
        {
            name: 'makeys',
            displayKey: 'name',
            source: makeys.ttAdapter(),
            templates: {
                empty: Handlebars.compile($('#tt-makey-suggestion-empty-template').html()),
                suggestion: Handlebars.compile($('#tt-makey-suggestion-template').html())
            }
        });

        this.$('#add_module_input').on("typeahead:selected", function(event, selected, dataset){
            that.saveModule(selected.id);
        });
    },

    showPartSearchLoading: function() {
        this.$('#update_parts .tt-hint').css('background-image', 'url("{% static 'images/ajax-loader.gif' %}")');
        this.$('#update_parts .tt-hint').css('background-position', 'right center');
        this.$('#update_parts .tt-hint').css('background-repeat', 'no-repeat');
    },

    hidePartSearchLoading: function() {
        this.$('#update_parts .tt-hint').css('background-image', '');
    },

    showMakeySearchLoading: function() {
        this.$('#update_modules .tt-hint').css('background-image', 'url("{% static 'images/ajax-loader.gif' %}")');
        this.$('#update_modules .tt-hint').css('background-position', 'right center');
        this.$('#update_modules .tt-hint').css('background-repeat', 'no-repeat');
    },

    hideMakeySearchLoading: function() {
        this.$('#update_modules .tt-hint').css('background-image', '');
    },

    resetPartSuggestion: function() {
        this.$('#new_part').typeahead('val', '');
    },

    resetModuleSuggestion: function() {
        this.$('#add_module_input').typeahead('val', '');
    },

    showAddComponentModal: function() {
        this.$('#add_parts_modal').modal('show');
        this.showModifyParts();
    },

    hideAddComponentModal: function() {
        this.$('#add_parts_modal').modal('hide');
    },

    partMixpanelClick: function(event){
        var part_id = parseInt(event.currentTarget.id.substring(8));
        var part = app.makey.parts.get(part_id);
        var position = app.makey.parts.indexOf(part);
        var t= event.currentTarget.id.substring(6,7);
        var target;

        if (t=='I')
            target="Image"
        else if(t=='T')
            target="Text"
        if (app.cur_fb_user)
        {

            var user_name=app.cur_fb_user.first_name
            var user_id=app.cur_fb_user.id
        }
        mixpanel.track("MakeyP: Part clicked", {part_id:part_id,part_name:part.attributes.name,position:position,target:target,user_id:user_id,user_name:user_name});
    },

    resetView : function() {
        this.$('#makey_parts').html('');
    },

    addAll : function() {
        this.$('#makey_parts').html('');

        this.$('#makey_modules').html('');

        this.$('#component-empty').hide();

        if (app.makey.modules.length > 0 || app.makey.parts.length>0 || app.makey.new_parts.length>0) {
            // $('.show_parts').show();
        }
        else {
            this.$('#component-empty').show();
        }

        // if(cur_user_details.id !== undefined) {
            app.makey.modules.each(this.addModule, this);
            app.makey.parts.each(this.add, this);
            app.makey.new_parts.each(this.addNewPart, this);
        // } else {
        //     this.$('#makey_parts').append(this.login_template());
        // }

        this.$el.find('.tooltips').tooltip();
        $('.parts_no').html(app.makey.modules.length + app.makey.parts.models.length + app.makey.new_parts.models.length);
    },

    fetchMakeyDetails: function(json){
        if(json.added_time === undefined) {
            return {};
        }

        var details = {};
        details['name'] = json.name;
        details['id'] = json.id;
        details['url'] = '/makey/' + json.id + '/';

        var img_url = "";
        if(json.cover_pic !== undefined && json.cover_pic !== null){
            var cover_pic = json.cover_pic;
            if(cover_pic.small_url !== null) {
                img_url = cover_pic.small_url;
            } else {
                img_url = cover_pic.large_url;
            }
        } else if(json.images !== undefined && json.images.length > 0){
            var first_img = json.images[0];
            if(first_img.small_url !== null) {
                img_url = first_img.small_url;
            } else {
                img_url = first_img.large_url;
            }
        } else {
            {% load static %}
            img_url = "{% static 'images/tools.jpg' %}";
        }

        if(!img_url)
            img_url = "{% static 'images/tools.jpg' %}";

        details['img_url'] = img_url;
        return details;
    },

    addModule: function(model){
        var makey_details = this.fetchMakeyDetails(model.toJSON());

        this.$('#makey_modules').append(this.module_template({
            'makey_id': makey_details['id'],
            'makey_name': makey_details['name'],
            'makey_url': makey_details['url'],
            'makey_img_url': makey_details['img_url'],
        }));

        return;
    },

    add : function(model) {
        this.$('#makey_parts').append(this.template(model.toJSON()));

        this.fetchPopoverData(model);
        this.initPopover(model);
        return this;
    },

    fetchPopoverData : function(model) {
        var part_id = model.get('id');
        var part = app.partpops.get(part_id);
        if(part === undefined) {
            var tempPart = new app.PartPop({'id' : part_id});
            app.partpops.push(tempPart);
        }
    },

    initPopover : function(model) {
        var imgId = model.get('id');
        this.$('[imgId="part_' + imgId + '"]').popover(this.popoverSettings);
    },

    addNewPart : function(model) {
        this.$('#makey_parts').append(this.template_new_part(model.toJSON()));
    },

    createNewPart : function() {
        this.removeSavedMessage();

        var new_part_name = $('#new_part_name').val();
        var new_part_url = $('#new_part_url').val();

        if(new_part_name == "" || new_part_url == "") {
            this.$('#failed_new_part_add').show();
            if(new_part_name == "") {
                this.$('#new_part_name').select();
            } else {
                this.$('#new_part_url').select();
            }
            return;
        }

        var url_regex = /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_]*)?\??(?:[\-\+=&;%@\.\w_]*)#?(?:[\.\!\/\\\w]*))?)/;
        if(!url_regex.test(new_part_url)) {
            this.$('#error_new_part_url').show();
            this.$('#new_part_url').select();
            return;
        }

        var part = new app.NewPart({
            'name' : new_part_name,
            'url' : new_part_url,
        });

        var that = this;
        this.$('#success_new_part_add').hide();
        this.$('#waiting_new_part_add').show();
        part.save(null, {
            success : function(model, response) {
                // that.$('#waiting_new_part_add').hide();
                // that.$('#success_new_part_add').show();

                app.makey.new_parts.add(model);
                app.makey.get('new_parts').push(model.get('resource_uri'));
                app.makey.save({
                    'new_parts': app.makey.get('new_parts'),
                }, {
                    patch : true,
                });

                mixpanel.track("MakeyP: Event", {event_type: "makey_new_part_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 part_id: model.get('id')});

                that.hideAddComponentModal();
            },
        });

        this.$('#new_part_name').val('');
        this.$('#new_part_url').val('');
    },

    removeSavedMessage : function() {
        this.$('#success_part_add').hide();
        this.$('#success_part_change').hide();

        this.$('#waiting_new_part_add').hide();
        this.$('#success_new_part_add').hide();
        this.$('#failed_new_part_add').hide();
        this.$('#error_new_part_url').hide();

        this.$('#update_parts').hide();
        this.$('#update_modules').hide();
    },

    addPartToMakey : function(part_id) {
        if(app.makey.parts.get(parseInt(part_id)) !== undefined) {
            return;
        }

        var part = new app.Part({'id' : part_id});
        var that = this;
        this.$('#success_part_add').hide();
        this.$('#waiting_part_add').show();
        part.fetch({
            success : function(model, response) {
                // that.$('#waiting_part_add').hide();
                // that.$('#success_part_add').show();

                app.makey.parts.add(model);
                app.makey.get('parts').push(model.get('resource_uri'));
                app.makey.save({
                    'parts': app.makey.get('parts'),
                }, {
                    patch : true,
                    success: function() {
                        // that.$('#success_part_add').hide();
                        that.hideAddComponentModal();
                    }
                });

                mixpanel.track("MakeyP: Event", {event_type: "makey_part_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 part_id: model.get('id')});
            },
        });


    },

    removePart : function(e) {

        var $btnEl = $(e.target);
        var part_id = $btnEl.data('id');

        var part = app.makey.parts.get(part_id);

        var index = app.makey.get('parts').indexOf(part.get('resource_uri'));
        app.makey.get('parts').splice(index, 1);

        var that = this;
        // this.$('#success_part_change').hide();
        // this.$('#waiting_part_change').show();
        app.makey.save({
            'parts': app.makey.get('parts'),
        }, {
            patch : true,
            success : function(model, response) {
                // that.$('#waiting_part_change').hide();
                // that.$('#success_part_change').show();

                mixpanel.track("MakeyP: Event", {
                    event_type: "makey_part_deleted",
                    user_id:cur_user_details.id,
                    makey_id:{{makey_id}},
                    part_id: part_id
                });

                app.makey.parts.remove(part);
            },
        });
        this.$('#part-item-' + part_id).remove();
    },

    removeNewPart : function(e) {
        var $btnEl = $(e.target);
        var part_id = $btnEl.data('id');
        var part = app.makey.new_parts.get(part_id);

        var that = this;
        // this.$('#success_part_change').hide();
        // this.$('#waiting_part_change').show();

        part.save({'is_enabled': false}, {
            success: function(){
                var index = app.makey.get('new_parts').indexOf(part.get('resource_uri'));
                app.makey.get('new_parts').splice(index, 1);

                app.makey.save({
                    'new_parts': app.makey.get('new_parts'),
                }, {
                    patch : true,
                    success : function(model, response) {
                        // that.$('#waiting_part_change').hide();
                        // that.$('#success_part_change').show();

                        mixpanel.track("MakeyP: Event", {
                            event_type: "makey_new_part_deleted",
                            user_id: cur_user_details.id,
                            makey_id: {{makey_id}},
                            part_id: part_id
                        });
                        app.makey.new_parts.remove(part);
                    },
                });
            },
        });
        this.$('#newpart-item-' + part_id).remove();

    },

    partHover : function(event) {
        var part_id = parseInt(event.currentTarget.id.substring(8));
        var part = app.partpops.get(part_id);
        if(part === undefined) {
            var tempPart = new app.PartPop({'id' : part_id});
            app.partpops.push(tempPart);
            part = tempPart;
        }

        var imgId = event.target.getAttribute('imgId');
        var json = part.toJSON();
        json.stores_count = part.stores.meta.total_count;
        json.makeys_count = part.makeys.meta.total_count;
        json.tutorials_count = part.tutorials.meta.total_count;
        this.$('#parts_hover_content')[0].innerHTML = this.part_popover_template(json);
        this.$('[imgId="'+imgId+'"]').popover('show');

        var that = this;
        this.$('[imgId="'+imgId+'"]').siblings('.popover').on('mouseleave', function() {
            that.$('[imgId="'+imgId+'"]').popover('hide');
        });

        // mixpanel.track("MakeyP: Part Hover", {user_id:user_id, part_id:part_id, makey_id:app.makey.get('id')});
        if(cur_user_details.id) {
            user_id = cur_user_details.id;
        } else {
            user_id = -1;
        }
        mixpanel.track("MakeyP: Event", {event_type: "makey_part_hover", user_id:user_id, makey_id:{{makey_id}},
                                         part_id: part_id});
    },

    partHoverOut : function(event) {
        var imgId = event.target.getAttribute('imgId');
        if(!this.$('.popover:hover').length) {
            this.$('[imgId="'+imgId+'"]').popover('hide');
        }
    },

    showModifyParts: function(event) {
        this.$('.add-part-tab-btn').addClass("active");
        this.$('.add-module-tab-btn').removeClass("active");
        this.resetPartSuggestion();
        this.$('#update_parts').show();
        this.$('#update_modules').hide();
        this.$('#success_part_add').hide();
        this.$('#waiting_part_add').hide();
        this.$('#waiting_new_part_add').hide();
        this.$('#success_new_part_add').hide();
        this.$('#new_part').focus();
    },

    showModifyModules: function(event) {
        this.$('.add-part-tab-btn').removeClass("active");
        this.$('.add-module-tab-btn').addClass("active");
        this.resetModuleSuggestion();
        this.$('#update_parts').hide();
        this.$('#update_modules').show();
        this.$('#success_module_add').hide();
        this.$('#waiting_module_add').hide();
        this.$('#add_module_input').focus();
    },

    addTemp: function(makey_details){
        this.$('#makey_module_temp').html('');
        this.$('#makey_module_temp').append(this.module_template({
            'makey_name': makey_details['name'],
            'makey_url': makey_details['url'],
            'makey_img_url': makey_details['img_url'],
        }));
        return;
    },

    saveModule: function(makey_id){

        var newModule = new app.MakeyBasic({
            'resource_uri': '/api/v1/makey/' + makey_id + '/',
        });

        newModule.fetch({
            success: function(model, response) {
                app.makey.modules.add(model);
                app.makey.get('modules_used').push(model.get('resource_uri'));
                app.makey.save({
                    'modules_used': app.makey.get('modules_used'),
                }, {
                    patch : true,
                });

                mixpanel.track("MakeyP: Event", {
                    event_type: "makey_module_added",
                    user_id:cur_user_details.id,
                    makey_id:{{makey_id}},
                    module_id: model.get('id')
                });
            },
        });

        this.hideAddComponentModal();
    },

    removeModule: function(e) {

        var $btnEl = $(e.target);
        var module_id  = $btnEl.data('id');
        var module = app.makey.modules.get(module_id);

        var that = this;

        var index = app.makey.get('modules_used').indexOf(module.get('resource_uri'));
        app.makey.get('modules_used').splice(index, 1);

        app.makey.save({
            'modules_used': app.makey.get('modules_used'),
        }, {
            patch : true,
            success : function(model, response) {
                mixpanel.track("MakeyP: Event", {
                    event_type: "makey_module_deleted",
                    user_id: cur_user_details.id,
                    makey_id: {{makey_id}},
                    module_id: module_id,
                });
            },
        });

        app.makey.modules.remove(module);
        this.$('#module-item-'+module_id).remove();
    }
});

app.MakeyToolsView = Backbone.View.extend({
    el : $('#tools'),

    template : Handlebars.compile($('#makey_tools_template').html()),
    template_new_tool : Handlebars.compile($('#makey_new_tool_template').html()),

    pager_template : Handlebars.compile($('#makey_tool_pager_template').html()),
    pager_template_new_tool : Handlebars.compile($('#makey_new_tool_pager_template').html()),

    tool_suggestion_template : Handlebars.compile($('#makey_tool_suggestion_template').html()),
    login_template : Handlebars.compile($('#tools_login_template').html()),
    tool_popover_template : Handlebars.compile($('#tools_popover_template').html()),

    events : {
        'keyup #new_tool' : 'suggestNewTools',

        'click .tool' : 'toolClick',
        'click #add_new_tool' : 'createNewTool',

        'click .remove_tool' : 'removeTool',
        'click .remove_new_tool' : 'removeNewTool',
        'click #close_tool_modal' : 'removeSavedMessage',

        'mouseover .tool' : 'toolHover',
        'mouseout .tool' : 'toolHoverOut',
    },

    popoverSettings : {
        trigger : 'manual',
        html : true,
        placement : "auto top",
        content : function() {
            return $('#tools_hover_content').html();
        },
    },

    initialize : function() {
        this.listenTo(app.makey.tools, 'add', this.addAll);
        this.listenTo(app.makey.tools, 'change', this.addAll);
        this.listenTo(app.makey.tools, 'remove', this.addAll);

        this.listenTo(app.makey.tools, 'reset', this.resetView);

        this.listenTo(app.makey.new_tools, 'change', this.addAll);
        this.listenTo(app.makey.new_tools, 'add', this.addAll);
        this.listenTo(app.makey.new_tools, 'remove', this.addAll);

        this.addAll();

        this.$('#add_tools_modal').on('shown.bs.modal', function(){
            $('#new_tool').focus();
        });
    },

    resetView : function() {
        this.$('#makey_tools').html('');
    },

    addAll : function() {
        this.$('#makey_tools').html('');
        this.$('#final_tools_list').html('');

        if (app.makey.tools.length>0 || app.makey.new_tools.length>0)
            $('.show_tools').show();

        app.makey.tools.each(this.add, this);
        app.makey.new_tools.each(this.addNewTool, this);

        this.$el.find('.tooltips').tooltip();
        $('.tools_no').html(app.makey.tools.models.length + app.makey.new_tools.models.length);

        // if(app.makey.tools.models.length == 0) {
        //     this.$el.hide();
        // }
    },

    add : function(model) {
        this.$('#makey_tools').append(this.template(model.toJSON()));
        this.$('#final_tools_list').append(this.pager_template(model.toJSON()));
        this.initPopover(model);
        this.fetchPopoverData(model);
    },

    addNewTool : function(model) {
        this.$('#makey_tools').append(this.template_new_tool(model.toJSON()));
        this.$('#final_tools_list').append(this.pager_template_new_tool(model.toJSON()));
    },

    fetchPopoverData : function(model) {
        var tool_id = model.get('id');
        var tool = app.toolpops.get(tool_id);
        if(tool === undefined) {
            var tempTool = new app.PartPop({'id' : tool_id});
            app.toolpops.push(tempTool);
        }
    },

    initPopover : function(model) {
        var imgId = model.get('id');
        this.$('[imgId="tool_' + imgId + '"]').popover(this.popoverSettings);
    },

    removeSavedMessage : function() {
        this.$('#success_tool_add').hide();
        this.$('#success_tool_change').hide();

        this.$('#waiting_new_tool_add').hide();
        this.$('#success_new_tool_add').hide();
        this.$('#failed_new_tool_add').hide();
        this.$('#error_new_tool_url').hide();
    },

    suggestNewTools : function() {
        var query = this.$("#new_tool").val();
        if(query == "") {
            this.$('#tools_list').html('');
            return;
        }

        var that = this;
        this.$('#tools_list').html('');
        this.$('#loading_suggestions').show();
        $.ajax({
            url: {% url 'catalog:search_autocomplete' %},
            type: "GET",
            data: {'q':query},
        }).done(function(msg) {
            var html = "";
            that.$('#loading_suggestions').hide();

            if(query == "") {
                that.$("#tools_list").html("");
            } else {
                var tools = msg.split("##");

                for(var i=0; i<tools.length-1; i++) {
                    var cur_tool = tools[i].split("~~~");
                    var tool_id = cur_tool[1];
                    var tool_name = cur_tool[0];

                    if(app.makey.tools.get(parseInt(tool_id)) !== undefined) {
                        continue;
                    }

                    that.$('#tools_list').append(that.tool_suggestion_template({
                        'tool_id' : tool_id,
                        'tool_name' : tool_name,
                    }));
                }
            }
        });
    },

    toolClick : function() {
        var tool_id = parseInt(event.target.id.substring(5));
        if(app.makey.tools.get(parseInt(tool_id)) !== undefined) {
            return;
        }

        var tool_name = $(event.target).text();
        this.$('#new_tool').val('');
        this.$('#tools_list').html('');

        var tool = new app.Part({'id' : tool_id});
        var that = this;
        this.$('#success_tool_add').hide();
        this.$('#waiting_tool_add').show();
        tool.fetch({
            success : function(model, response) {
                that.$('#waiting_tool_add').hide();
                that.$('#success_tool_add').show();
                that.$('#final_tools_list').append(that.pager_template(response));

                app.makey.tools.add(model);
                app.makey.get('tools').push(model.get('resource_uri'));
                app.makey.save({
                    'tools': app.makey.get('tools'),
                }, {
                    patch : true,
                });

                mixpanel.track("MakeyP: Event", {event_type: "makey_tool_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 tool_id: tool_id});
            },
        });
    },

    removeTool : function() {
        if(!confirm("Are you sure you want to delete this?")) {
            return;
        }
        var tool_id = parseInt(event.target.id.substring(5));
        var tool = app.makey.tools.get(tool_id);
        app.makey.tools.remove(tool);

        var index = app.makey.get('tools').indexOf(tool.get('resource_uri'));
        app.makey.get('tools').splice(index, 1);

        var that = this;
        this.$('#success_tool_change').hide();
        this.$('#waiting_tool_change').show();
        app.makey.save({
            'tools': app.makey.get('tools'),
        }, {
            patch : true,
            success : function(model, response) {
                that.$('#waiting_tool_change').hide();
                that.$('#success_tool_change').show();

                mixpanel.track("MakeyP: Event", {event_type: "makey_tool_deleted", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 tool_id: tool_id});
            },
        });

        this.$('#tool_'+tool_id).remove();
    },

    toolHover : function(event) {
        var tool_id = parseInt(event.currentTarget.id.substring(8));
        var tool = app.toolpops.get(tool_id);
        if(tool === undefined) {
            var temptool = new app.PartPop({'id' : tool_id});
            app.toolpops.push(temptool);
            tool = temptool;
        }

        var imgId = event.target.getAttribute('imgId');
        var json = tool.toJSON();
        json.stores_count = tool.stores.meta.total_count;
        json.makeys_count = tool.makeys.meta.total_count;
        json.tutorials_count = tool.tutorials.meta.total_count;
        this.$('#tools_hover_content')[0].innerHTML = this.tool_popover_template(json);
        this.$('[imgId="'+imgId+'"]').popover('show');

        var that = this;
        this.$('[imgId="'+imgId+'"]').siblings('.popover').on('mouseleave', function() {
            that.$('[imgId="'+imgId+'"]').popover('hide');
        });

        // mixpanel.track("MakeyP: Tool Hover", {user_id:user_id, tool_id:tool_id, makey_id:app.makey.get('id')});
        if(cur_user_details.id) {
            user_id = cur_user_details.id;
        } else {
            user_id = -1;
        }
        mixpanel.track("MakeyP: Event", {event_type: "makey_tool_hover", user_id:user_id, makey_id:{{makey_id}},
                                         tool_id: tool_id});
    },

    toolHoverOut : function(event) {
        var imgId = event.target.getAttribute('imgId');
        if(!this.$('.popover:hover').length) {
            this.$('[imgId="'+imgId+'"]').popover('hide');
        }
    },

    createNewTool : function() {
        this.removeSavedMessage();

        var new_tool_name = $('#new_tool_name').val();
        var new_tool_url = $('#new_tool_url').val();

        if(new_tool_name == "" || new_tool_url == "") {
            this.$('#failed_new_tool_add').show();
            if(new_tool_name == "") {
                this.$('#new_tool_name').select();
            } else {
                this.$('#new_tool_url').select();
            }
            return;
        }

        var url_regex = /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_]*)?\??(?:[\-\+=&;%@\.\w_]*)#?(?:[\.\!\/\\\w]*))?)/;
        if(!url_regex.test(new_tool_url)) {
            this.$('#error_new_tool_url').show();
            this.$('#new_tool_url').select();
            return;
        }

        var tool = new app.NewPart({
            'name' : new_tool_name,
            'url' : new_tool_url,
        });

        var that = this;
        this.$('#success_new_tool_add').hide();
        this.$('#waiting_new_tool_add').show();
        tool.save(null, {
            success : function(model, response) {
                that.$('#waiting_new_tool_add').hide();
                that.$('#success_new_tool_add').show();
                that.$('#final_tools_list').append(that.pager_template_new_tool(response));

                app.makey.new_tools.add(model);
                app.makey.get('new_tools').push(model.get('resource_uri'));
                app.makey.save({
                    'new_tools': app.makey.get('new_tools'),
                }, {
                    patch : true,
                });

                mixpanel.track("MakeyP: Event", {event_type: "makey_new_tool_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 tool_id: model.get('id')});
            },
        });

        this.$('#new_tool_name').val('');
        this.$('#new_tool_url').val('');
    },

    removeNewTool : function() {
        this.removeSavedMessage();
        if(!confirm("Are you sure you want to delete this?")) {
            return;
        }

        var tool_id  = parseInt(event.target.id.substring(9));
        var tool = app.makey.new_tools.get(tool_id);
        app.makey.new_tools.remove(tool);

        var index = app.makey.get('new_tools').indexOf(tool.get('resource_uri'));
        app.makey.get('new_tools').splice(index, 1);

        var that = this;
        this.$('#success_tool_change').hide();
        this.$('#waiting_tool_change').show();
        app.makey.save({
            'new_tools': app.makey.get('new_tools'),
        }, {
            patch : true,
            success : function(model, response) {
                that.$('#waiting_tool_change').hide();
                that.$('#success_tool_change').show();

                mixpanel.track("MakeyP: Event", {event_type: "makey_new_tool_deleted", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 tool_id: tool_id});
            },
        });

        this.$('#new_tool_'+part_id).remove();
    },
});

app.MakeyNotesView = Backbone.View.extend({
    el : $('#notes'),
    template : Handlebars.compile($('#makey_notes_template').html()),
    login_template : Handlebars.compile($('#notes_login_template').html()),
    comment_popover_template : Handlebars.compile($('#comment_popover_template').html()),
    comments_close_template : Handlebars.compile($('#comments_close_template').html()),
    new_comment_template : Handlebars.compile($('#new_comment_template').html()),

    note_image_template : Handlebars.compile($('#note_image_template').html()),
    note_reorder_template : Handlebars.compile($('#reorder_note_template').html()),

    events : {
        "click #save_new_note" : "createNewNote",
        "click .close_note_modal" : "removeSavedMessage",
        "click .edit_delete_note" : "loadEditNoteDetails",
        "click #save_edit_note" : "editNote",
        "click #delete_note" : "deleteNote",

        "click .like_note" : "likeNote",
        "click .comment_note" : "commentsNoteOpen",
        "click .close_comment" : "commentsNoteClose",
        "click .new_comment" : "newComment",
        "click .submit_comment" : "saveComment",
        "click .cancel_comment" : "cancelComment",

        'click #save_notes_reorder' : 'saveReorderNotes',

        "click .show_image" : "showImage",
        "click #selectNoteImage" : "showSelectNoteImage",
        "click #selectNewNoteImage" : "showSelectNewNoteImage",
        "click #save_note_image" : "saveNoteImage",
    },

    options : {
        new_comment_shown : false,
    },

    popoverSettings : {
        trigger : 'manual',
        html : true,
        placement : "left",
        template : '<div class="popover notePopover"><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>',
    },

    initialize : function() {
        this.listenTo(app.makey.notes, 'destroy', this.addAll);
        this.listenTo(app.makey.notes, 'change', this.addAll);
        this.listenTo(app.makey.notes, 'add', this.addAll);
        this.listenTo(app.makey.notes, 'remove', this.addAll);
        this.listenTo(app.makey.notes, 'reset', this.addAll);

        this.addAll();
    },

    resetView : function() {
        this.$('#makey_notes').html('');
    },

    addAll : function() {
        this.$('#makey_notes').html('');
        this.$('#reorder_notes_list').html('');
        this.$('#select_note_image_list').html('');

        if (app.makey.notes.length>0 )
            $('.show_notes').show();

        app.makey.notes.sort();
        app.makey.notes.each(this.add, this);

        // Note Image Selector
        this.$('#select_note_image_list').append('<input type="hidden" class="form-control" name="note_id" value="">');
        app.makey.images.each(this.loadImageSelector, this);
        this.$('#select_note_image_list').append('<input type="hidden" class="form-control" name="note_id" value="">');

        this.$('#makey_notes').find('.tooltips').tooltip();
        $('.notes_no').html(app.makey.notes.models.length);
    },

    loadImageSelector : function(model) {
        this.$('#select_note_image_list').append(this.note_image_template(model.toJSON()));
    },

    showSelectNoteImage : function() {
        this.$('#note_image_modal').modal('show');
    },

    showSelectNewNoteImage : function() {
        this.$('input[name="note_id"]').val(-1);
        this.$('#note_image_modal').modal('show');
    },

    saveNoteImage : function() {
        var imageId = parseInt(this.$('input[name="note_image_id"]:checked').val());
        var noteId = parseInt(this.$('input[name="note_id"]').val());

        if(noteId != -1) {
            var curNote = app.makey.notes.get(noteId);

            curNote.set({
                'image' : '/api/v1/image/' + imageId + "/",
            });

            curNote.save(curNote.unsavedAttributes(), {
                patch : true,
                success : function(model, response) {
                    app.makey.images.get(imageId).fetch();
                    mixpanel.track("MakeyP: Event", {event_type: "makey_note_image_added", user_id:cur_user_details.id, makey_id:{{makey_id}}, note_id: noteId, image_id: imageId});
                },
            });
        } else {
            this.$('#new_note_image').val('/api/v1/image/' + imageId + "/");
            this.$("#new_note_image_preview").find('img').attr('src', app.makey.images.get(imageId).get('large_url'));
            this.$('#note_image_modal').modal('hide');
        }
    },

    add : function(model) {
        if(model.get('id') === undefined) {
            return;
        }

        var json = model.toJSON();
        if(json.body!=undefined) {
            json.body = json.body.replace(/\n/g, "<br/>");
            json.body = Autolinker.link(json.body);
        }
        json.can_edit = app.can_edit;

        if(json.image) {
            json.image_id = json.image.replace('/api/v1/image/','').replace('/','');
        }

        this.$('#makey_notes').append(this.template(json));

        if(app.cur_note_id == model.get('id')){
            $('html, body').animate({
                scrollTop: $("#note_"+app.cur_note_id).offset().top
            }, 1500);
        }

        // Reorder Notes
        this.reorderNotesView(model);

        this.initPopover(model);
    },

    reorderNotesView : function(model) {
        this.$('#reorder_notes_list').append(this.note_reorder_template(model.toJSON()));
    },

    saveReorderNotes : function() {
        var notes_list = this.$('#reorder_notes_list :input');

        for(var i=0; i<notes_list.length; i++) {
            var note_id = parseInt(notes_list[i].id.substring(11));
            var order = parseInt(notes_list[i].value);

            var curNote = app.makey.notes.get(note_id);
            curNote.set({'order' : order});
            curNote.save(curNote.unsavedAttributes(), {
                patch : true,
            });

        }
        mixpanel.track("MakeyP: Event", {event_type: "makey_notes_reordered", user_id:cur_user_details.id, makey_id:{{makey_id}}});
    },

    initPopover : function(model) {
        var noteId = model.get('id');
        var popoverSettings = this.popoverSettings;
        popoverSettings.title = this.comments_close_template(model.toJSON());
        popoverSettings.content = function() {
            return $('#note_comments_'+noteId).html();
        };

        this.$('#note_'+noteId).popover(popoverSettings);
        var that = this;
        this.$('#note_'+noteId).on('hidden.bs.modal', function(e){
            if(that.$('#cancel_comment_'+noteId)) {
                that.$('#cancel_comment_'+noteId).parent().parent().remove();
            }
            that.options.new_comment_shown = false;
        });
    },

    createNewNote : function() {
        var title = this.$('#new_note_title')[0].value;
        var body = this.$('#new_note_body')[0].value;
        var image = this.$('#new_note_image').val();
        var note = new app.Note({
            'title' : title,
            'body' : body,
            'image' : image,
        });

        var that = this;
        this.$('#success_new_note').hide();
        this.$('#waiting_new_note').show();
        note.save(null, {
            success : function(model, response) {
                that.$('#waiting_new_note').hide();
                that.$('#success_new_note').show();
                app.makey.notes.add(model);
                app.makey.get('notes').push(model.get('resource_uri'));
                app.makey.save({
                    'notes': app.makey.get('notes'),
                }, {
                    patch : true,
                });

                that.$('#new_note_title').val('');
                that.$('#new_note_body').val('');

                mixpanel.track("MakeyP: Event", {event_type: "makey_note_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 note_id: model.get('id')});
            },
        });
    },

    removeSavedMessage: function() {
        this.$('#success_new_note').hide();
        this.$('#success_edit_note').hide();
    },

    loadEditNoteDetails : function(event) {
        var note_id = parseInt(event.target.id.substring(10));
        var note = app.makey.notes.get(note_id);

        this.$('#edit_note_title')[0].value = note.get('title');
        this.$('#edit_note_body')[0].value = note.get('body');
        this.$('#edit_note_id')[0].value = note_id;

        if(note.get('image')) {
            var imgId = parseInt(note.get('image').replace('/api/v1/image/','').replace('/',''));
            this.$('#note_image_preview').find('img').attr('src',
                app.makey.images.get(imgId).get('large_url'));
        }


        this.$('input[name="note_id"]').val(note_id);

        this.$('#edit_note_modal').modal();
    },

    editNote : function() {
        var title = this.$('#edit_note_title')[0].value;
        var body = this.$('#edit_note_body')[0].value;
        var note_id = this.$('#edit_note_id')[0].value;

        var note = app.makey.notes.get(note_id);
        note.set({
            'title' : title,
            'body' : body,
        });

        var that = this;
        this.$('success_edit_note').hide();
        this.$('waiting_edit_note').show();
        note.save(note.unsavedAttributes(), {
            patch : true,
            success : function(model, response) {
                that.$('#waiting_edit_note').hide();
                that.$('#success_edit_note').show();

                mixpanel.track("MakeyP: Event", {event_type: "makey_note_edited", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 note_id: note_id});
            },
        });
    },

    deleteNote : function() {
        if(!confirm("Are you sure you want to delete this?")) {
            return;
        }

        var that = this;
        this.$('#success_tool_change').hide();
        this.$('#waiting_tool_change').show();

        var note_id = this.$('#edit_note_id')[0].value;
        var note = app.makey.notes.get(note_id);
        note.save({'is_enabled': false},{
            success: function(){
                var index = app.makey.get('notes').indexOf(note.get('resource_uri'));
                app.makey.get('notes').splice(index, 1);

                app.makey.save({
                    'notes': app.makey.get('notes'),
                }, {
                    patch : true,
                    success : function(model, response) {
                        that.$('#waiting_tool_change').hide();
                        that.$('#success_tool_change').show();

                        mixpanel.track("MakeyP: Event", {
                            event_type: "makey_note_deleted",
                            user_id: cur_user_details.id,
                            makey_id: {{makey_id}},
                            note_id: note_id
                        });
                    },
                });
            }
        });

        app.makey.notes.remove(note);
        this.$('#note_'+note_id).remove();

        this.$('#edit_note_modal').modal('toggle');
    },

    likeNote : function(event) {
        if(cur_user_details.id === undefined) {
            $('#login_modal').modal('show');
            return;
        }

        var btn_details = event.target.id.split('_');
        var noteId = parseInt(btn_details[1]);
        var likeId = parseInt(btn_details[2]);

        var curNote = app.makey.notes.get(noteId);

        if(likeId == 0) {
            var newLike = new app.NoteLike({
                'note' : curNote.get('resource_uri'),
                'liker' : app.cur_fb_user,
            });
            newLike.save(null, {
                success : function(model, response) {
                    curNote.set({
                        'cur_user_likes' : true,
                        'like_id' : model.get('id'),
                        'likes_count' : parseInt(curNote.get('likes_count'))+1,
                    });
                    _cio.track("noteLikes",{makey_id:'{{makey_id}}',note_id:noteId});

                    var collab = curNote.get('user');
                    var mail = new app.SendMail({
                        'to': collab.email,
                        'to_name': collab.first_name,
                        'mail_type': 4,
                        'actor_id': cur_user_details.id,
                        'target_id': curNote.get('id'),
                    });
                    mail.save();

                    mixpanel.track("MakeyP: Event", {event_type: "makey_note_liked", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                     note_id: noteId});
                },
            });
        } else {
            var newLike = new app.NoteLike({
                'id' : likeId,
            });
            newLike.destroy();
            curNote.set({
                'cur_user_likes' : false,
                'like_id' : 0,
                'likes_count' : parseInt(curNote.get('likes_count'))-1,
            });
            mixpanel.track("MakeyP: Event", {event_type: "makey_note_unliked", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                             note_id: noteId});
        }
    },

    commentsNoteOpen : function(event) {
        var noteId = parseInt(event.target.id.substring(14));
        var curNote = app.makey.notes.get(noteId);

        var json = {
            'comments' : curNote.comments.toJSON(),
            'id' : noteId,
        };
        this.$('#note_comments_'+noteId)[0].innerHTML = this.comment_popover_template(json);

        this.$('#note_'+noteId).popover('toggle');
    },

    commentsNoteClose : function(event) {
        var noteId = event.target.id.substring(15);
        this.$('#note_'+noteId).popover('hide');
        this.options.new_comment_shown = false;
    },

    newComment : function(event) {
        if(cur_user_details.id === undefined) {
            $('#login_modal').modal('show');
            return false;
        }

        if(this.options.new_comment_shown) {
            return;
        }

        var noteId = parseInt(event.target.id.substring(12));
        this.options.new_comment_shown = true;
        var json = app.cur_fb_user;
        json.note_id = noteId;
        $(event.target).before(this.new_comment_template(json));
    },

    saveComment : function(event) {
        var body = this.$('#new_comment_body')[0].value;
        var noteId = this.$('#new_comment_body')[0].getAttribute('noteId');
        var comment = new app.Comment({
            'body' : body,
        });

        var that = this;
        this.$('#success_new_comment').hide();
        this.$('#waiting_new_comment').show();
        comment.save(null, {
            success : function(model, response) {
                that.$('#waiting_new_comment').hide();
                that.$('#success_new_comment').show();

                var curNote = app.makey.notes.get(noteId);
                curNote.comments.add(response);

                curNote.get('comments').push(model.get('resource_uri'));
                curNote.save({
                    'comments': curNote.get('comments'),
                }, {
                    patch : true,
                    success: function(){
                        var collab = curNote.get('user');
                        var mail = new app.SendMail({
                            'to': collab.email,
                            'to_name': collab.first_name,
                            'mail_type': 104,
                            'actor_id': cur_user_details.id,
                            'target_id': model.get('id'),
                        });
                        mail.save();
                    }
                });

                that.$('#new_comment_body').val('');
                that.options.new_comment_shown = false;

                //TODO: #makeyMail send mail to all collaborators about new comment on insight
                _cio.track("noteComments",{makey_id:'{{makey_id}}',note_id:noteId});
                mixpanel.track("MakeyP: Event", {event_type: "makey_note_comment_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 note_id: noteId, comment_id: model.get('id')});
            },
        });

    },

    cancelComment : function(event) {
        $(event.target).parent().parent().remove();
        this.options.new_comment_shown = false;
    },

    showImage : function(event) {
        var imageId = parseInt(event.target.id.substring(11));
        app.imagesView.showImage(imageId);
        $('#images_modal').modal('show');

        //TODO: note_id to be fetched.
        if(cur_user_details.id) {
            user_id = cur_user_details.id;
        } else {
            user_id = -1;
        }
        mixpanel.track("MakeyP: Event", {event_type: "makey_note_image_viewed", user_id:user_id, makey_id:{{makey_id}},
                                         image_id: imageId});
    },
});


app.MakeyNotesViewV2 = Backbone.View.extend({
    el : $('#notes'),
    $itemsEl : this.$("#makey-notes-v2-items"),
    emptyTemplate: Handlebars.compile($("#makey-notes-v2-empty-template").html()),

    initialize : function() {
        this.initChildViews();

        this.listenTo(app.makey.notes, "reset", this.renderNotes);
        this.listenTo(app.makey.notes, "add", this.renderNotes);
        this.listenTo(app.makey.notes, "change", this.renderNotes);
        this.listenTo(app.makey.notes, "remove", this.renderNotes);

        this.render();
    },

    initChildViews: function() {
        this.noteItemViews = new Array();
        this.addView = new app.MakeyNoteAddView();
        this.addView.on("noteAdded", this.handleNoteAdd, this);
    },

    initNotes: function() {
        this.noteItemViews = new Array();
        app.makey.notes.sort();
        app.makey.notes.each(function(model){
            var newItemView = new app.MakeyNoteItemView({
                note: model
            });
            this.noteItemViews.push(newItemView);
            newItemView.on("noteReordered", this.handleNoteReorder, this);
        }, this);
    },

    renderNotes: function() {
        this.initNotes();
        this.$itemsEl.empty();
        if(this.noteItemViews.length) {
            _.each(this.noteItemViews, function(itemView){
                this.$itemsEl.append(itemView.render().$el);
            }, this);
        } else {
            this.$itemsEl.html(this.emptyTemplate());
        }
    },

    renderAddInput: function() {
        this.addView.render();
    },

    render: function() {
        this.renderNotes();
        this.renderAddInput();
        return this;
    },

    reset: function() {
        this.clear();
        this.render();
    },

    clear: function() {
        this.addView.clear();

        _.each(this.noteItemViews, function(itemView){
            itemView.clear();
        }, this);
    },

    handleNoteAdd: function(model) {
        app.makey.notes.add(model);
        app.makey.get('notes').push(model.get('resource_uri'));
        app.makey.save({
            'notes': app.makey.get('notes'),
        }, {
            patch : true
        });

        mixpanel.track("MakeyP: Event", {
            event_type: "makey_note_added",
            user_id:cur_user_details.id,
            makey_id:{{makey_id}},
            note_id: model.get('id')
        });
    },

    handleNoteReorder: function() {
        var allNotes = this.$('.note_item_v2');

        for(var order=0; order<allNotes.length; ++order) {
            var note_id = $(allNotes[order]).data('note-id');
            var note = app.makey.notes.get(note_id);
            if(note && note.get('order') != order) {
                note.save({'order': order}, {
                    silent: true,
                    patch: true
                });
            }
        }
    },
});

app.MakeyNoteItemView = Backbone.View.extend({

    className: "makey-notes-v2-item",
    template : Handlebars.compile($('#makey-notes-v2-item-template').html()),
    editTemplate : Handlebars.compile($("#makey-notes-v2-item-edit-template").html()),
    moveTemplate : Handlebars.compile($("#makey-notes-v2-item-move-template").html()),

    events: {
        'click .edit-note-v2': 'startNoteEdit',
        'click .insight-edit-cancel-btn': 'cancelNoteEdit',
        'click .insight-edit-save-btn': 'saveNoteEdit',
        'click .btn-delete-confirm': 'deleteNote',
        'click .btn-approve-confirm': 'approveNote',
        'click .reorder-up': 'moveUpNote',
        'click .reorder-down': 'moveDownNote',
        'click .makey-notes-v2-edit-image-select': 'selectNoteImage',
        'click .move-note-v2': 'startNoteMove',
        'click .insight-move-cancel-btn': 'cancelNoteMove',
        'click .insight-move-save-btn': 'saveNoteMove',
    },

    initialize: function(options) {
        this.note = options.note;
        this.editing = false;
        this.imageSelectView = new app.imageSelectView();
        this.imageSelectView.on("imageSelected", this.handleImageSelected, this);
        this.imageSelected = false;
    },

    render: function() {
        if(this.note.get("id") === undefined) {
            return this;
        }

        var json = this.note.toJSON();
        json.body = json.body.replace(/\n/g, "<br/>");


        if(this.editing)
            this.$el.html(this.editTemplate(this.note.toJSON()));
        else if(this.moving)
            this.$el.html(this.moveTemplate(this.note.toJSON()));
        else
            this.$el.html(this.template(json));

        this.$el.find('.tooltips').tooltip();

        return this;
    },

    clear: function() {
        this.$el.empty();
    },

    startNoteEdit: function() {
        this.editing = true;
        this.imageSelected = false;
        this.render();
    },

    cancelNoteEdit: function() {
        this.editing = false;
        this.imageSelected = false;
        this.render();
    },

    saveNoteEdit: function() {
        var title = this.$(".makey-notes-v2-edit-input-title").val();
        var body = this.$(".makey-notes-v2-edit-input-body").val();
        var image = '';

        if(this.selectedImage)
            image = this.selectedImage.get('resource_uri');
        else if(this.note.get("image"))
            image = this.note.get('resource_uri');

        if(!title || !body) {
            return;
        }

        var that = this;
        this.note.save({
            'title': title,
            'body': body,
            'image': image
        }, {
            patch: true,
            silent: true,
            success: function() {
                that.cancelNoteEdit();
            }
        });
    },

    initMoveSearch: function() {
        var that = this;
        var makeys = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                remote: {
                    url: '/api/v1/makey/search?q=%QUERY&u=' + {{user.id}},
                        filter: function(list) {
                            return $.map(list.makeys, function(makey) {
                                return { name: makey.name,
                                         id: "/api/v1/makey/" + makey.id + "/",
                                         user_name: makey.user.first_name + " " + makey.user.last_name };
                            });
                        },
                        ajax: {
                            beforeSend: function() {
                                that.showSearchLoading();
                            },
                            complete: function() {
                                that.hideSearchLoading();
                            }
                        }
                },
                limit: 10
        });
        makeys.initialize();

        this.$('.makey-notes-v2-move-input-name').typeahead({
            hint: true,
            highlight: true,
            minLength: 1
        },
        {
            name: 'makeys',
            displayKey: 'name',
            source: makeys.ttAdapter(),
            templates: {
                empty: Handlebars.compile($('#tt-makey-suggestion-empty-template').html()),
                suggestion: Handlebars.compile($('#tt-makey-suggestion-template').html())
            }
        });

        var that = this;
        this.$('.makey-notes-v2-move-input-name').on("typeahead:selected", function(event, selected, dataset){
            console.log(selected.id);
            that.$('.makey-notes-v2-move-input-id').val(selected.id);
        });
    },

    showSearchLoading: function() {
        this.$('.tt-hint').css('background-image', 'url("{% static 'images/ajax-loader.gif' %}")');
        this.$('.tt-hint').css('background-position', 'right center');
        this.$('.tt-hint').css('background-repeat', 'no-repeat');
    },

    hideSearchLoading: function() {
        this.$('.tt-hint').css('background-image', '');
    },

    startNoteMove: function() {
        this.moving = true;
        this.render();
        this.initMoveSearch();
    },

    cancelNoteMove: function() {
        this.moving = false;
        this.render();
    },

    saveNoteMove: function() {
        var makeyUri = this.$('.makey-notes-v2-move-input-id').val();

        var temp = Backbone.Tastypie.Model.extend({
            url: makeyUri,
            isNew: function() { return false; },
        });
        var newMakey = new temp();
        var that = this;
        newMakey.fetch({
            success: function() {
                that.addNoteToMakey(newMakey);
                that.removeNoteFromMakey();
            },
        });
    },

    addNoteToMakey: function(newMakey) {
        newMakey.get('notes').push(this.note.get('resource_uri'));
        newMakey.save({
            'notes': newMakey.get('notes'),
        }, {
            patch : true,
        });
    },

    removeNoteFromMakey: function() {
        var note = this.note;
        var index = app.makey.get('notes').indexOf(note.get('resource_uri'));
        app.makey.get('notes').splice(index, 1);

        app.makey.save({
            'notes': app.makey.get('notes'),
            'moving': true,
            'moving_id': note.get('resource_uri'),
        }, {
            patch : true,
        });

        app.makey.notes.remove(note);
    },

    deleteNote : function() {
        var note_id = this.note.get("id");
        var note = app.makey.notes.get(note_id);
        note.save({'is_enabled': false}, {
            success: function(){
                var index = app.makey.get('notes').indexOf(note.get('resource_uri'));
                app.makey.get('notes').splice(index, 1);

                app.makey.save({
                    'notes': app.makey.get('notes'),
                }, {
                    patch : true,
                    success : function(model, response) {
                        mixpanel.track("MakeyP: Event", {
                            event_type: "makey_note_deleted",
                            user_id: cur_user_details.id,
                            makey_id: {{makey_id}},
                            note_id: note_id
                        });
                    },
                });
            }
        });

        app.makey.notes.remove(note);
    },

    approveNote : function() {
        var note_id = this.note.get("id");
        var note = app.makey.notes.get(note_id);
        note.save({'is_pending_approval': false}, {
            patch: true
        });
    },

    moveUpNote: function() {
        this.$el.insertBefore(this.$el.prev());
        this.saveNoteOrder();
    },

    moveDownNote: function() {
        this.$el.insertAfter(this.$el.next());
        this.saveNoteOrder();
    },

    saveNoteOrder: function() {
        this.trigger("noteReordered");
    },

    selectNoteImage: function() {
        this.imageSelectView.show();
    },

    handleImageSelected: function(imgId) {
        var image = app.makey.images.get(imgId);
        this.$('.makey-notes-v2-edit-image-select').attr("src", image.get('large_url'));
        this.selectedImage = image;
        this.imageSelectView.hide();
    }

});

app.MakeyNoteAddView = Backbone.View.extend({
    el: "#notes",
    template: Handlebars.compile($("#makey-notes-v2-add-template").html()),
    default_image: 'http://placehold.it/150x100&text=Add+Image',

    events: {
        'click .add-insight-btn': 'showAddForm',
        'click #insight-add-cancel-btn': 'hideAddForm',
        'click #insight-save-btn': 'createNote',
        'click #makey-notes-v2-add-image-select': 'selectNoteImage',
    },

    initialize: function(options) {
        this.imageSelectView = new app.imageSelectView();
        this.imageSelectView.on("imageSelected", this.handleImageSelected, this);

        this.$('#insight-add-input-container').on('shown.bs.modal',function(){
            $('#makey-notes-v2-add-input-title').focus();
        });
    },

    render: function() {
        this.$('#makey-notes-v2-add').html(this.template());
        return this;
    },

    clear: function() {
        this.$('#makey-notes-v2-add').empty();
    },

    resetForm: function() {
        this.$("#makey-notes-v2-add-input-title").val("");
        this.$("#makey-notes-v2-add-input-body").val("");
        this.$('#makey-notes-v2-add-image-select').attr("src", this.default_image);
        this.selectedImage = undefined;
    },

    showAddForm: function() {
        this.$("#insight-add-btn-container").hide();
        this.$("#insight-add-input-container").show();
    },

    hideAddForm: function() {
        this.$("#insight-add-input-container").hide();
        this.$("#insight-add-btn-container").show();
    },

    createNote: function() {
        var title = this.$("#makey-notes-v2-add-input-title").val();
        var body = this.$("#makey-notes-v2-add-input-body").val();
        var image = '';
        if(this.selectedImage)
            image = this.selectedImage.get('resource_uri');

        if(!title || !body) {
            return;
        }

        var newNote = new app.Note({
            'title' : title,
            'body' : body,
            'image' : image,
            'order': app.makey.notes.length
        });

        var that = this;
        newNote.save(null, {
            success : function(model, response) {
                that.trigger("noteAdded", model);
                that.resetForm();
            },
        });
    },

    selectNoteImage: function() {
        this.imageSelectView.show();
    },

    handleImageSelected: function(imgId) {
        var image = app.makey.images.get(imgId);
        this.$('#makey-notes-v2-add-image-select').attr("src", image.get('large_url'));
        this.selectedImage = image;
        this.imageSelectView.hide();
    }
});

app.imageSelectView = Backbone.View.extend({

    className: 'modal fade',
    template: Handlebars.compile($("#makey-notes-v2-image-select-template").html()),

    events: {
        'click .img-select': 'selectImage'
    },

    initialize: function() {
        this.render();
    },

    render: function() {
        this.$el.html(this.template({
            images: app.makey.images.toJSON()
        }));
    },

    show: function() {
        this.render();
        this.$el.modal('show');
    },

    hide: function() {
        this.$el.modal('hide');
    },

    selectImage: function(e) {
        $imgEl = $(e.target);
        var imgId = $imgEl.data('image-id')
        this.trigger("imageSelected", imgId);
    }

});


app.MakeyTextDocumentationView = Backbone.View.extend({
    el : $('#docs-text'),
    $itemsEl : this.$("#makey-textdocs-items"),
    emptyTemplate: Handlebars.compile($("#makey-textdocs-empty-template").html()),

    initialize : function() {
        this.initChildViews();

        this.listenTo(app.makey.textdocs, "reset", this.renderItems);
        this.listenTo(app.makey.textdocs, "add", this.renderItems);
        this.listenTo(app.makey.textdocs, "change", this.renderItems);
        this.listenTo(app.makey.textdocs, "remove", this.renderItems);

        this.render();
    },

    initChildViews: function() {
        this.itemViews = new Array();
        this.addView = new app.MakeyTextDocumentationAddView();
        this.addView.on("itemCreated", this.handleItemCreate, this);
    },

    initItems: function() {
        this.itemViews = new Array();
        app.makey.textdocs.sort();
        app.makey.textdocs.each(function(model){
            // if(model.get('is_enabled') == false)
            //     return;
            var newItemView = new app.MakeyTextDocumentationItemView({
                textdoc: model
            });
            this.itemViews.push(newItemView);
            newItemView.on("itemReordered", this.handleItemReorder, this);
            newItemView.on("itemDeleted", this.handleItemDelete, this);
        }, this);
    },

    renderItems: function() {
        this.initItems();
        this.$itemsEl.empty();
        if(this.itemViews.length) {
            _.each(this.itemViews, function(itemView){
                this.$itemsEl.append(itemView.render().$el);
            }, this);
        } else {
            this.$itemsEl.html(this.emptyTemplate());
        }
        $('.docs_text_no').html(app.makey.textdocs.length);
    },

    renderAdd: function() {
        this.addView.render();
    },

    render: function() {
        this.renderItems();
        this.renderAdd();
        return this;
    },

    reset: function() {
        this.clear();
        this.render();
    },

    clear: function() {
        // this.addView.render();

        // _.each(this.itemViews, function(itemView){
        //     itemView.clear();
        // }, this);
    },

    handleItemCreate: function(item) {

        app.makey.textdocs.add(item);
        app.makey.get('text_documentations').push(item.get('resource_uri'));

        NProgress.set(0.5);
        app.makey.save({
            'text_documentations': app.makey.get('text_documentations'),
        }, {
            patch : true,
            success: function() {
                NProgress.done();
                mixpanel.track("MakeyEdit: Event", {
                    event_type: "makey_textdoc_added",
                    user_id:cur_user_details.id,
                    makey_id:{{makey_id}},
                    note_id: item.get('id')
                });
            }
        });

    },

    handleItemDelete: function(item) {
        var index = app.makey.get('text_documentations').indexOf(item.get('resource_uri'));
        app.makey.get('text_documentations').splice(index, 1);

        NProgress.set(0.5);
        app.makey.save({
            'text_documentations': app.makey.get('text_documentations'),
        }, {
            patch : true,
            success : function(model, response) {
                NProgress.done();
                mixpanel.track("MakeyEdit: Event", {
                    event_type: "makey_textdoc_deleted",
                    user_id:cur_user_details.id,
                    makey_id:{{makey_id}},
                    doc_id: item.get('id')
                });
                app.makey.textdocs.remove(item);
            },
        });
    },

    handleItemReorder: function() {
        var allItems = this.$('.textdoc_item');

        NProgress.start();
        for(var order=0; order<allItems.length; ++order) {
            var item_id = $(allItems[order]).data('id');
            var item = app.makey.textdocs.get(item_id);
            if(item && item.get('order') != order) {
                item.save({'order': order}, {
                    silent: true,
                    patch: true
                });
            }
        }
        NProgress.done();
    },
});


app.MakeyTextDocumentationItemView = Backbone.View.extend({

    className: "makey-textdocs-item",
    template : Handlebars.compile($('#makey-textdocs-item-template').html()),
    editTemplate : Handlebars.compile($("#makey-textdocs-item-edit-template").html()),

    events: {
        'click .edit-item': 'showItemEdit',
        'click .btn-item-edit-save': 'saveItemEdit',
        'click .btn-delete-confirm': 'deleteItem',
        'click .reorder-up': 'moveUpItem',
        'click .reorder-down': 'moveDownItem',
        // 'click .makey-notes-v2-edit-image-select': 'selectNoteImage',
    },

    initialize: function(options) {
        this.textdoc = options.textdoc;
        // this.imageSelectView = new app.imageSelectView();
        // this.imageSelectView.on("imageSelected", this.handleImageSelected, this);
        // this.imageSelected = false;
    },

    render: function() {
        if(this.textdoc.get("id") === undefined) {
            return this;
        }

        this.$el.html(this.template(this.textdoc.toJSON()));

        return this;
    },

    clear: function() {
        this.$el.empty();
    },

    renderModal: function() {
        this.getModalContainer().html(this.editTemplate(this.textdoc.toJSON()));
        this.$(".doc-edit-input-title").val(this.textdoc.get('title'));
        this.$(".doc-edit-input-body").val(this.textdoc.get('body'));
        this.$('.doc-edit-input-body').wysihtml5();
        var that = this;
        this.getModalEl().on("hidden.bs.modal", function() {
            that.render();
        });
    },

    showItemEdit: function() {
        this.renderModal();
        this.getModalEl().modal('show');
    },

    hideItemEdit: function() {
        this.getModalEl().modal('hide');
    },

    getModalContainer: function() {
        return this.$('.item-edit-modal-container');
    },

    getModalEl: function() {
        return this.$('.edit-textdoc-modal');
    },

    saveItemEdit: function() {
        var title = this.$(".doc-edit-input-title").val();
        var body = this.$(".doc-edit-input-body").val();

        if(!title || !body) {
            return;
        }

        var that = this;
        NProgress.start();
        var notif = $.growl({
            message: " Updating...",
            icon: "fa fa-circle-o-notch fa-spin"
        },{
            type: 'info',
            allow_dismiss: false,
            delay: -1
        });
        this.textdoc.save({
            'title': title,
            'body': body
        }, {
            patch: true,
            silent: true,
            success: function() {
                that.hideItemEdit();
                NProgress.done();
                notif.close();
                $.growl({
                    message: " Updated!",
                    icon: "fa fa-check"
                },{
                    type: 'success',
                    allow_dismiss: false,
                    delay: 3000
                });
            }
        });
    },

    deleteItem : function() {
        var textdoc_id = this.textdoc.get("id");
        var textdoc = app.makey.textdocs.get(textdoc_id);
        NProgress.start();
        var that = this;
        textdoc.save({'is_enabled': false}, {
            patch: true,
            success: function(model, response){
                that.trigger("itemDeleted", model);
            }
        });
    },

    moveUpItem: function() {
        this.$el.insertBefore(this.$el.prev());
        this.saveItemOrder();
    },

    moveDownItem: function() {
        this.$el.insertAfter(this.$el.next());
        this.saveItemOrder();
    },

    saveItemOrder: function() {
        this.trigger("itemReordered");
        $.growl({
            message: " Reordered!",
            icon: "fa fa-check"
        },{
            type: 'success',
            allow_dismiss: false,
            delay: 3000
        });
    },

    // selectItemImage: function() {
    //     this.imageSelectView.show();
    // },

    // handleImageSelected: function(imgId) {
    //     var image = app.makey.images.get(imgId);
    //     this.$('.makey-notes-v2-edit-image-select').attr("src", image.get('large_url'));
    //     this.selectedImage = image;
    //     this.imageSelectView.hide();
    // }

});

// makey-textdocs-item-add-template

app.MakeyTextDocumentationAddView = Backbone.View.extend({
    el: "#docs-text",
    template: Handlebars.compile($("#makey-textdocs-item-add-template").html()),

    events: {
        'click .add-textdoc-btn': 'showForm',
        'click .btn-item-add-save': 'createItem'
    },

    initialize: function(options) {
        // this.imageSelectView = new app.imageSelectView();
        // this.imageSelectView.on("imageSelected", this.handleImageSelected, this);
        this.render();

        this.getModalEl().on('shown.bs.modal', function(){
            $("#doc-add-input-title").focus();
        });
    },

    render: function() {
        this.getModalContainer().html(this.template());
        this.initEditor();
        return this;
    },

    clear: function() {
        this.$('#add-textdoc-container').empty();
    },

    resetForm: function() {
        this.render();
    },

    showForm: function() {
        this.resetForm();
        this.getModalEl().modal('show');
    },

    hideForm: function() {
        this.getModalEl().modal('hide');
    },

    getModalEl: function() {
        return this.$("#add-textdoc-modal");
    },

    getModalContainer: function() {
        return this.$('#add-textdoc-modal-container');
    },

    initEditor: function() {
        this.$('#doc-add-input-body').wysihtml5();
    },

    createItem: function() {
        var title = this.$("#doc-add-input-title").val();
        var body = this.$("#doc-add-input-body").val();
        // var image = '';
        // if(this.selectedImage)
            // image = this.selectedImage.get('resource_uri');

        if(!title) {
            this.$("#doc-add-input-title").notify(
                "Title is mandatory!",
                { position:"right" }
            );
        }

        if(!body) {
            this.$("#textdoc-add-input-body").notify(
                "This field is mandatory!",
                { position:"bottom center" }
            );
        }

        if(!title || !body) {
            return;
        }

        var order = app.makey.textdocs.length;
        var user = "/api/v1/user/" + cur_user_details.id + "/";

        var newItem = new app.TextDocumentation({
            'title' : title,
            'body' : body,
            'order': order,
            'user': user
        });

        var that = this;
        NProgress.start();
        newItem.save(null, {
            success : function(model, response) {
                that.trigger("itemCreated", model);
                that.hideForm();
            },
        });
    },

    // selectNoteImage: function() {
    //     this.imageSelectView.show();
    // },

    // handleImageSelected: function(imgId) {
    //     var image = app.makey.images.get(imgId);
    //     this.$('#makey-notes-v2-add-image-select').attr("src", image.get('large_url'));
    //     this.selectedImage = image;
    //     this.imageSelectView.hide();
    // }
});


app.MakeyCreditsView = Backbone.View.extend({
    el : $('#credits'),

    events : {
        "click #save_edit_credits" : "updateCredits",
        "click #close_credits_modal" : "removeCreditsSavedMessage",
    },

    initialize : function() {
        this.listenTo(app.makey, 'change:credits', this.add);

        this.$('#edit_credits_modal').on('shown.bs.modal',function(){
            $('#edit_credits').focus();
        });
    },

    add : function() {
        var json = app.makey.toJSON();
        if(!json.credits) {
            return;
        }
        $('.show_mentors').show();
        this.$('#makey_credits').html(json.credits.replace(/\n/g, "<br/>"));
        this.$('#edit_credits').html('');
        this.$('#edit_credits').append(json.credits);
    },

    updateCredits : function() {
        var credits = this.$('#edit_credits')[0].value;
        app.makey.set({'credits' : credits});

        var that = this;
        this.$('#success_credits').hide();
        this.$('#waiting_credits').show();
        app.makey.save({
            'credits': app.makey.get('credits'),
        }, {
            patch : true,
            success : function(model, response) {
                that.$('#waiting_credits').hide();
                that.$('#success_credits').show();

                mixpanel.track("MakeyP: Event", {event_type: "makey_credits_edited", user_id:cur_user_details.id, makey_id:{{makey_id}}});
            },
        });
    },

    removeCreditsSavedMessage : function() {
        this.$('#waiting_credits').hide();
        this.$('#success_credits').hide();
    },
});

app.MakeyMentorsView = Backbone.View.extend({
    el : $('#mentors'),

    events : {
        "click #save_edit_mentors" : "updateMentors",
        "click #close_mentors_modal" : "removeMentorsSavedMessage",
    },

    initialize : function() {
        this.listenTo(app.makey, 'change:mentors', this.add);

        this.$('#edit_mentors_modal').on('shown.bs.modal', function(){
            $('#edit_mentors').focus();
        });
    },

    add : function() {
        var json = app.makey.toJSON();

        if(!json.mentors) {
            return;
        }
        $('.show_mentors').show();
        this.$('#makey_mentors').html(json.mentors.replace(/\n/g, "<br/>"));
        this.$('#edit_mentors').html('');
        this.$('#edit_mentors').append(json.mentors);
    },

    updateMentors : function() {
        var mentors = this.$('#edit_mentors')[0].value;
        app.makey.set({'mentors' : mentors});

        var that = this;
        this.$('#success_mentors').hide();
        this.$('#waiting_mentors').show();
        app.makey.save({
            'mentors': app.makey.get('mentors'),
        }, {
            patch : true,
            success : function(model, response) {
                that.$('#waiting_mentors').hide();
                that.$('#success_mentors').show();

                mixpanel.track("MakeyP: Event", {event_type: "makey_mentors_edited", user_id:cur_user_details.id, makey_id:{{makey_id}}});
            },
        });
    },

    removeMentorsSavedMessage : function() {
        this.$('#waiting_mentors').hide();
        this.$('#success_mentors').hide();
    },
});

app.MakeyStatusView = Backbone.View.extend({
    el : $('#status'),

    events : {
        "click #save_edit_status" : "updateStatus",
        "click #close_status_modal" : "removeStatusSavedMessage",
    },

    initialize : function() {
        this.listenTo(app.makey, 'change:status', this.add);
    },

    add : function() {
        var json = app.makey.toJSON();

        $('.show_status').show();
        var currentStatus = json.status;
        if(currentStatus)
            this.$('#makey_status').html(currentStatus);
        else
            this.$('#makey_status').html(app.defaultMakeyStatus);

        var radioInputs = this.$("#status-radio-container input[type='radio']");

        radioInputs.filter('[value="'+json.status+'"]').prop('checked', true);

        if(radioInputs.is(':checked') === false) {
            radioInputs.filter('[value="app.defaultMakeyStatus"]').prop('checked', true);
        }
    },

    updateStatus : function() {

        var selected = this.$("#status-radio-container input[type='radio']:checked");
        var selectedStatus = selected.val();

        app.makey.set({'status' : selectedStatus});

        var that = this;
        this.$('#success_status').hide();
        this.$('#waiting_status').show();
        app.makey.save({
            'status': app.makey.get('status'),
        }, {
            patch : true,
            success : function(model, response) {
                that.$('#waiting_status').hide();
                that.$('#success_status').show();
            },
        });
    },

    removeStatusSavedMessage : function() {
        this.$('#waiting_status').hide();
        this.$('#success_status').hide();
    },
});


app.MakeyWhyView = Backbone.View.extend({
    el : $('#whydo'),

    events : {
        "click #save_edit_why" : "updateWhy",
        "click #close_why_modal" : "removeWhySavedMessage",
    },

    initialize : function() {
        this.listenTo(app.makey, 'change:why', this.add);

        this.$('#edit_why_modal').on('shown.bs.modal', function(){
            $('#edit_why').focus();
        });
    },

    add : function() {
        var json = app.makey.toJSON();

        if(!json.why) {
            return;
        }

        $('.show_why').show();
        this.$('#makey_why').html(json.why.replace(/\n/g, "<br/>"));
        this.$('#edit_why').html('');
        this.$('#edit_why').append(json.why);
    },

    updateWhy : function() {
        var why = this.$('#edit_why')[0].value;
        app.makey.set({'why' : why});

        var that = this;
        this.$('#success_why').hide();
        this.$('#waiting_why').show();
        app.makey.save({
            'why': app.makey.get('why'),
        }, {
            patch : true,
            success : function(model, response) {
                that.$('#waiting_why').hide();
                that.$('#success_why').show();
            },
        });
    },

    removeWhySavedMessage : function() {
        this.$('#waiting_why').hide();
        this.$('#success_why').hide();
    },
});


app.MakeyInfoView = Backbone.View.extend({
    el : $('#name-editable-container'),
    name_view_template : Handlebars.compile($('#name_view_template').html()),
    name_edit_template : Handlebars.compile($('#name_edit_template').html()),

    events : {
        'click #btn-edit-name': 'showEditable',
        'click #btn-edit-name-cancel': 'showStatic',
        'click #btn-edit-name-save': 'saveName',
    },

    initialize : function() {
        this.listenTo(app.makey, 'change:name', this.showStatic);
        this.listenTo(app.makey, 'change:cover_pic', this.showStatic);
        this.showStatic();
    },

    showStatic : function() {
        if(app.makey === undefined ) {
            return;
        }

        this.$el.html(this.name_view_template({
            name: app.makey.get('name')
        }));

        this.showCoverPic();
    },

    showEditable: function() {
        if(app.makey === undefined ) {
            return;
        }

        this.$el.html(this.name_edit_template({
            name: app.makey.get('name')
        }));

        this.$('#edit-name-input').focus();

        this.showCoverPic();
    },

    saveName : function() {
        var name = this.$('#edit-name-input').val();
        if(!name || name == app.makey.get('name')) {
            this.showStatic();
            return;
        }

        NProgress.start();
        app.makey.save({
            'name': name,
        }, {
            patch : true,
            success : function(model, response) {
                NProgress.done();
                mixpanel.track("MakeyP: Event", {event_type: "makey_name_edited", user_id:cur_user_details.id, makey_id:{{makey_id}}});
            },
        });
    },

    showCoverPic: function() {
        if(app.makey.get('cover_pic') === undefined) {
            return;
        }

        if(app.makey.get('cover_pic') !== null) {
            var imageId = parseInt(app.makey.get('cover_pic').replace('/api/v1/image/','').replace('/',''));
            var curImage = app.makey.images.get(imageId);
            if(curImage === undefined || curImage.get('large_url') === undefined) {
                var bg_image = new app.Image({'resource_uri' : app.makey.get('cover_pic')});
                bg_image.fetch({
                    success : function(model, response) {
                        if(response.large_url) {
                            $('#bg').backstretch(response.large_url);
                            $('meta[property="og:image"]')[0].content = response.large_url;
                            // $('#bg').css('z-index', '');
                        }
                    },
                });
            } else {
                $('#bg').backstretch(curImage.get('large_url'));
                $('meta[property="og:image"]')[0].content = curImage.get('large_url');
                // $('#bg').css('z-index', '');
            }
        }
    },
});

app.MakeyCommentsView = Backbone.View.extend({
    el : '#comments',
    template : Handlebars.compile($('#comment_template').html()),
    empty_comments_template : Handlebars.compile($('#comments_empty_template').html()),
    login_template : Handlebars.compile($('#comments_login_template').html()),

    events : {
        'click #create_comment' : 'checkLoginStatus',
        'click #save_new_comment' : 'createNewComment',
        'click #close_new_comment_modal' : 'removeSavedMessage',

        'click .like_comment' : 'likeComment',
    },

    initialize : function() {
        this.listenTo(app.makey.comments, 'destroy', this.addAll);
        this.listenTo(app.makey.comments, 'change', this.addAll);
        this.listenTo(app.makey.comments, 'add', this.addAll);

        this.listenTo(app.makey.comments, 'reset', this.resetView);
    },

    removeSavedMessage : function() {
        this.$('#waiting_new_comment').hide();
        this.$('#success_new_comment').hide();
    },

    resetView : function() {
        this.$('#makey_comments').html('');
        // if(cur_user_details.id === undefined) {
            // this.$('#makey_comments').append(this.login_template());
        // } else {
            this.$('#makey_comments').append(this.empty_comments_template());
        // }
    },

    addAll : function() {
        this.$('#makey_comments').html('');
        if(app.makey.comments.models.length != 0) {
            app.makey.comments.each(this.add, this);
        } else {
            if(cur_user_details.id !== undefined) {
                this.$('#makey_comments').append(this.empty_comments_template());
            }
        }

        // if(cur_user_details.id === undefined) {
            // this.$('#makey_comments').append(this.login_template());
        // }
        this.$('#makey_comments').find('.tooltips').tooltip();
        $('.comments_no').html(app.makey.comments.models.length);
    },

    add : function(model) {
        this.$('#makey_comments').append(this.template(model.toJSON()));
        if(app.cur_comment_id) {
            if(model.get('id') == app.cur_comment_id) {
                $('html, body').animate({
                    scrollTop: $("#comment_"+app.cur_comment_id).offset().top
                }, 1500);
            }
        }
    },

    createNewComment : function() {
        var body = this.$('#new_comment_body')[0].value;
        var comment = new app.Comment({
            'body' : body,
        });

        var that = this;
        this.$('#success_new_comment').hide();
        this.$('#waiting_new_comment').show();
        comment.save(null, {
            success : function(model, response) {
                that.$('#waiting_new_comment').hide();
                that.$('#success_new_comment').show();

                app.makey.comments.add(model);
                app.makey.get('comments').push(model.get('resource_uri'));
                app.makey.save({
                    'comments': app.makey.get('comments'),
                }, {
                    patch : true,
                    success: function(){
                        for(var i=0; i<app.makey.collaborators.length; i++) {
                            var collab = app.makey.collaborators.models[i];
                            var mail = new app.SendMail({
                                'to': collab.get('email'),
                                'to_name': collab.get('first_name'),
                                'mail_type': 101,
                                'actor_id': cur_user_details.id,
                                'target_id': model.get('id'),
                            });
                            mail.save();
                        }
                    }
                });

                that.$('#new_comment_body').val('');
                _cio.track("makeyComments",{makey_id:'{{makey_id}}'});

                mixpanel.track("MakeyP: Event", {event_type: "makey_comment_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 comment_id: model.get('id')});
            },
        });
    },

    checkLoginStatus : function() {
        if(cur_user_details.id === undefined) {
            $('#login_modal').modal('show');
            return false;
        }
    },

    likeComment : function(event) {
        if(cur_user_details.id === undefined) {
            $('#login_modal').modal('show');
            return;
        }

        var btn_details = event.target.id.split('_');
        var commentId = parseInt(btn_details[1]);
        var likeId = parseInt(btn_details[2]);

        var curComment = app.makey.comments.get(commentId);

        if(likeId == 0) {
            var newLike = new app.CommentLike({
                'comment' : curComment.get('resource_uri'),
                'liker' : app.cur_fb_user,
            });
            newLike.save(null, {
                success : function(model, response) {
                    curComment.set({
                        'cur_user_likes' : true,
                        'like_id' : model.get('id'),
                        'likes_count' : parseInt(curComment.get('likes_count'))+1,
                    });
                    _cio.track("commentLikes",{makey_id:'{{makey_id}}',comment_id:commentId});

                    mixpanel.track("MakeyP: Event", {event_type: "makey_comment_liked", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                     comment_id: commentId});
                },
            });
        } else {
            var newLike = new app.CommentLike({
                'id' : likeId,
            });
            newLike.destroy();
            curComment.set({
                'cur_user_likes' : false,
                'like_id' : 0,
                'likes_count' : parseInt(curComment.get('likes_count'))-1,
            });

            mixpanel.track("MakeyP: Event", {event_type: "makey_comment_unliked", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                             comment_id: commentId});
        }
    },

});

app.MakeyImagesView = Backbone.View.extend({
    el : '#images',

    img_template : Handlebars.compile($('#image_template').html()),
    img_edit_template : Handlebars.compile($('#image_delete_template').html()),

    vid_template : Handlebars.compile($('#video_image_template').html()),
    vid_edit_template : Handlebars.compile($('#video_delete_template').html()),

    empty_line : Handlebars.compile($('#image_empty_line').html()),

    gallery_like : Handlebars.compile($('#gallery_like_template').html()),
    gallery_pager : Handlebars.compile($('#gallery_pager_template').html()),
    gallery_note : Handlebars.compile($('#gallery_note_template').html()),
    gallery_description : Handlebars.compile($('#gallery_description_template').html()),
    gallery_comments : Handlebars.compile($('#gallery_comments_template').html()),
    new_img_comment_template : Handlebars.compile($('#new_img_comment_template').html()),
    new_vid_comment_template : Handlebars.compile($('#new_vid_comment_template').html()),

    img_reorder_template : Handlebars.compile($('#reorder_image_template').html()),
    vid_reorder_template : Handlebars.compile($('#reorder_video_template').html()),
    select_cover_template : Handlebars.compile($('#select_cover_template').html()),

    image_upload_preview_template : Handlebars.compile($('#image_upload_preview_template').html()),
    image_add_modal_template : Handlebars.compile($('#image_add_modal_template').html()),
    image_remove_template : Handlebars.compile($('#image_remove_template').html()),
    image_coverpic_btn_template : Handlebars.compile($('#image_coverpic_btn_template').html()),

    gallery_move_template : Handlebars.compile($('#gallery_move_template').html()),
    gallery_move_start_template : Handlebars.compile($('#gallery_move_start_template').html()),

    options : {
        images_per_row : 4,
        cur_image_counter : 0,
        edit_image_counter : 0,
        edit_video_counter : 0,
        upload_retries: 0,
    },

    events : {
        'click .makey_image' : 'clickImage',
        'click .makey_video' : 'clickVideo',

        'click #edit_images' : 'showEditImages',
        'click #edit_videos' : 'showEditVideos',

        'click #reorder_images' : 'showReorderImages',
        'click #reorder_videos' : 'showReorderVideos',

        'click #save_images_reorder' : 'saveReorderImages',
        'click #save_videos_reorder' : 'saveReorderVideos',

        'click #close_image_edit' : 'closeEditModal',

        'click #save_image_v2' : 'createNewImage',
        'click #save_video_v2' : 'createNewVideo',

        'click .gallery' : 'galleryBrowse',

        'click #edit_description' : 'showEditDescription',
        'click #cancel_edit_description' : 'cancelEditDescription',
        'click #save_description' : 'saveDescription',

        'click .like_image' : 'likeImage',
        'click .like_video' : 'likeVideo',

        "change #up_images_v2" : "uploadImagesPreview",

        "click .add-images-v2": "showAddModal",
        "click .add-image-tab-btn": "showAddImageTab",
        "click .add-video-tab-btn": "showAddVideoTab",
        "click .image-delete-btn": "deleteImage",
        "click .video-delete-btn": "deleteVideo",
        "click #image-set-cover-pic": "saveCoverPic",

        "click .gallery-move-start-btn": "startGalleryMove",
        "click .gallery-move-cancel-btn": "cancelGalleryMove",
        "click .gallery-move-save-btn": "saveGalleryMove",
    },

    initialize : function() {
        this.listenTo(app.makey.images, 'add', this.addAll);
        this.listenTo(app.makey.images, 'change', this.addAll);
        this.listenTo(app.makey.images, 'destroy', this.addAll);
        this.listenTo(app.makey.images, 'remove', this.addAll);
        this.listenTo(app.makey.images, 'reset', this.addAll);

        this.listenTo(app.makey.videos, 'add', this.addAll);
        this.listenTo(app.makey.videos, 'change', this.addAll);
        this.listenTo(app.makey.videos, 'destroy', this.addAll);
        this.listenTo(app.makey.videos, 'remove', this.addAll);
        this.listenTo(app.makey.videos, 'reset', this.addAll);

        this.listenTo(app.makey, 'change:cover_pic', this.addAll);

        this.$('#add_image_v2_modal').on('shown.bs.modal', function(){
            $('#img_url_v2').focus();
        });
    },

    hideAll : function() {
        this.$('#main_image').hide();
        this.$('#main_video').hide();
        this.$('#image_list').hide();
    },

    addAll : function() {
        this.hideAll();
        this.$("#main_image").find('img').attr('src', '');
        this.$("#main_video").find('iframe').attr('src', '');

        this.$('#image_list').html('');
        this.options.cur_image_counter = 0;

        this.$('#edit_image_list').html('');
        this.options.edit_image_counter = 0;

        this.$('#edit_video_list').html('');
        this.options.edit_video_counter = 0;

        this.$('#reorder_images_list').html('');
        this.$('#reorder_videos_list').html('');
        this.$('#select_cover_list').html('');

        var videos = app.makey.videos;
        if(videos.size()) {
            videos.sort();
            this.$('#main_video').find('iframe').attr('src', videos.models[0].get('embed_url'));

            this.$('#image_list').show();
            app.makey.videos.each(this.renderVideo, this);
            this.$('#empty_images').hide();
        }

        var images = app.makey.images;

        if(images.size()) {
            images.sort();
            if(!videos.size()) {
                this.$("#main_image").find('img').attr('src', images.models[0].get('large_url'));
            }

            this.$('#image_list').show();
            app.makey.images.each(this.renderImage, this);

            //Cover Pic selected
            if(app.makey.get('cover_pic') !== undefined && app.makey.get('cover_pic') !== null) {
                var cover_id = app.makey.get('cover_pic').replace('/api/v1/image/','').replace('/','');
                this.$('input[name="cover_pic_id"]').filter('[value='+cover_id+']').prop('checked',true)
            }

            this.$('#empty_images').hide();
        }

        if(app.cur_video_id) {
            this.showVideo(app.cur_video_id);
        }

        if(app.cur_image_id) {
            this.showImage(app.cur_image_id);
        }

        if(!videos.size() && !images.size()){
            this.hideAll();
            this.$('#empty_images').show();
        }

        this.$el.find('.tooltips').tooltip();
        // $('#a_images').find('span').html(app.makey.images.models.length+app.makey.videos.models.length);
        $('.images_no').html(app.makey.images.models.length+app.makey.videos.models.length);
    },

    showAddModal: function() {
        this.$('#add_image_v2_modal').html(this.image_add_modal_template());
        this.$('#add_image_v2_modal').modal('show');
    },

    hideAddModal: function() {
        this.$('#add_image_v2_modal').modal('hide');
        this.$('#add_image_v2_modal').empty();
    },

    showAddImageTab: function() {
        this.$(".add-image-tab-btn").addClass("active");
        this.$(".add-video-tab-btn").removeClass("active");
        this.$("#add_images_form").show();
        this.$("#add_videos_form").hide();
        this.$('#img_url_v2').focus();
    },

    showAddVideoTab: function() {
        this.$(".add-image-tab-btn").removeClass("active");
        this.$(".add-video-tab-btn").addClass("active");
        this.$("#add_images_form").hide();
        this.$("#add_videos_form").show();
        this.$('#vid_url_v2').focus();
    },

    renderVideo : function(model) {
        if(this.options.cur_image_counter % this.options.images_per_row == 0) {
        // if(this.options.cur_image_counter  == 0) {
            this.$('#image_list').append(this.empty_line());
        }

        this.$('#image_list').find(".images_row").last().append(this.vid_template(model.toJSON()));
        this.options.cur_image_counter++;
        // Edit videos
        if(this.options.edit_video_counter % this.options.images_per_row == 0) {
            this.$('#edit_video_list').append(this.empty_line());
        }
        this.$('#edit_video_list').find('.images_row').last().append(this.vid_edit_template(model.toJSON()));
        this.options.edit_video_counter++;

        //Re-Order Videos
        this.reorderVideosView(model);

        return this;
    },

    renderImage : function(model) {
        if(this.options.cur_image_counter % this.options.images_per_row == 0) {
        // if(this.options.cur_image_counter ==0) {
            this.$('#image_list').append(this.empty_line());
        }

        this.$('#image_list').find(".images_row").last().append(this.img_template(model.toJSON()));
        this.options.cur_image_counter++;

        // Edit Images
        if(this.options.edit_image_counter % this.options.images_per_row == 0) {
            this.$('#edit_image_list').append(this.empty_line());
        }
        this.$('#edit_image_list').find('.images_row').last().append(this.img_edit_template(model.toJSON()));
        this.options.edit_image_counter++;

        //Re-Order Images
        this.reorderImageView(model);

        return this;
    },

    reorderImageView : function(model) {
        this.$('#reorder_images_list').append(this.img_reorder_template(model.toJSON()));
    },

    saveCoverPic : function(e) {

        $btnEl = $(e.target);
        var imageId = $btnEl.data('id');

        var that = this;
        app.makey.set({
            'cover_pic' : '/api/v1/image/' + imageId + "/",
        }, {silent: true});
        app.makey.save({
            'cover_pic': app.makey.get('cover_pic'),
        }, {
            patch : true,
            silent: true,
            success: function() {
                that.updateCoverPicButton(true, true, imageId);
            }
        });

        mixpanel.track("MakeyP: Event", {event_type: "makey_cover_pic_edited", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                         image_id: imageId});
    },

    updateCoverPicButton: function(showBtn, coverPic, id) {
        if(showBtn)
            this.$('#image-coverpic-container').html(this.image_coverpic_btn_template({
                cover_pic: coverPic,
                id: id
            }));
        else
            this.$('#image-coverpic-container').empty();
    },

    reorderVideosView : function(model) {
        this.$('#reorder_videos_list').append(this.vid_reorder_template(model.toJSON()));
    },

    initMoveSearch: function() {
        var that = this;
        var makeys = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                remote: {
                    url: '/api/v1/makey/search?q=%QUERY&u=' + {{user.id}},
                        filter: function(list) {
                            return $.map(list.makeys, function(makey) {
                                return { name: makey.name,
                                         id: "/api/v1/makey/" + makey.id + "/",
                                         user_name: makey.user.first_name + " " + makey.user.last_name };
                            });
                        },
                        ajax: {
                            beforeSend: function() {
                                that.showSearchLoading();
                            },
                            complete: function() {
                                that.hideSearchLoading();
                            }
                        }
                },
                limit: 10
        });
        makeys.initialize();

        this.$('.gallery-move-input-name').typeahead({
            hint: true,
            highlight: true,
            minLength: 1
        },
        {
            name: 'makeys',
            displayKey: 'name',
            source: makeys.ttAdapter(),
            templates: {
                empty: Handlebars.compile($('#tt-makey-suggestion-empty-template').html()),
                suggestion: Handlebars.compile($('#tt-makey-suggestion-template').html())
            }
        });

        var that = this;
        this.$('.gallery-move-input-name').on("typeahead:selected", function(event, selected, dataset){
            console.log(selected.id);
            that.$('.gallery-move-makey-id').val(selected.id);
        });
    },

    showSearchLoading: function() {
        this.$('.tt-hint').css('background-image', 'url("{% static 'images/ajax-loader.gif' %}")');
        this.$('.tt-hint').css('background-position', 'right center');
        this.$('.tt-hint').css('background-repeat', 'no-repeat');
    },

    hideSearchLoading: function() {
        this.$('.tt-hint').css('background-image', '');
    },


    startGalleryMove: function(event) {
        var type = event.target.getAttribute('data-type');
        var id = event.target.getAttribute('data-id');
        this.$('#gallery-move-container').html(this.gallery_move_start_template({id: id, type: type}));
        this.initMoveSearch();
    },

    cancelGalleryMove: function(event) {
        var type = event.target.getAttribute('data-type');
        this.$('#gallery-move-container').html(this.gallery_move_template({type: type}));
    },

    saveGalleryMove: function(event) {
        var makeyUri = this.$('.gallery-move-makey-id').val();
        var itemId = this.$('.gallery-move-item-id').val();
        var type = event.target.getAttribute('data-type');

        var temp = Backbone.Tastypie.Model.extend({
            url: makeyUri,
            isNew: function() { return false; },
        });
        var newMakey = new temp();
        var that = this;
        newMakey.fetch({
            success: function() {
                that.addGalleryItemToMakey(itemId, type, newMakey);
                that.removeGalleryItemFromMakey(itemId, type);
            },
        });
    },

    addGalleryItemToMakey: function(itemId, type, makey) {
        var item;
        if(type == 'image') {
            item = app.makey.images.get(itemId);
        } else if (type == 'video') {
            item = app.makey.videos.get(itemId);
        }

        makey.get(type + 's').push(item.get('resource_uri'));
        if(type == 'image') {
            makey.save({
                'images': makey.get(type + 's'),
            }, {
                patch : true,
            });
        } else if(type == 'video') {
            makey.save({
                'videos': makey.get(type + 's'),
            }, {
                patch : true,
            });
        }
    },

    removeGalleryItemFromMakey: function(itemId, type) {
        var item;
        if(type == 'image') {
            item = app.makey.images.get(itemId);
        } else if (type == 'video') {
            item = app.makey.videos.get(itemId);
        }

        var index = app.makey.get(type+'s').indexOf(item.get('resource_uri'));
        app.makey.get(type+'s').splice(index, 1);

        if(type=='image') {
            app.makey.save({
                'images': app.makey.get(type+'s'),
                'moving': true,
                'moving_id': item.get('resource_uri'),
            }, {
                patch : true,
            });
        } else if(type=='video') {
            app.makey.save({
                'videos': app.makey.get(type+'s'),
                'moving': true,
                'moving_id': item.get('resource_uri'),
            }, {
                patch : true,
            });
        }

        this.hideImage();

        if(type == 'image') {
            app.makey.images.remove(item);
        } else if (type == 'video') {
            app.makey.videos.remove(item);
        }
    },

    clickImage : function(event) {
        var image_id = parseInt(event.target.id.substring(4));
        this.showImage(image_id);
        this.$('#images_modal').modal('show');

        var image = app.makey.images.get(image_id);
        var position = app.makey.images.indexOf(image);
        if (app.cur_fb_user)
        {
            var user_name=app.cur_fb_user.first_name
            var user_id=app.cur_fb_user.id
        }

        // mixpanel.track("MakeyP: Image clicked", {image_id:image_id,position:position,user_id:user_id,user_name:user_name});
    },

    hideImage: function() {
        this.$('#images_modal').modal('hide');
    },

    showImage : function(id) {
        var curImage = app.makey.images.get(id);
        if(curImage === undefined || curImage.get('large_url') === undefined) {
            return;
        }

        this.$("#main_image").find('img').attr('src', curImage.get('large_url'));
        this.$('#main_video').find('iframe').attr('src', "");

        var json = {'id' : id, 'comments' : curImage.comments.toJSON(), 'type' : 'img'};
        this.$('#gallery_comments_list').html(this.gallery_comments(json));

        json = curImage.toJSON();
        json.likes_string = this.getLikesString(json, "image");
        json.type = "image"
        this.$('#gallery_like').html(this.gallery_like(json));

        json.can_edit = app.can_edit;
        this.$('#gallery_description').html(this.gallery_description(json));

        this.$('#image_note_row').hide();
        if(json.note.length > 0) {
            var noteId = parseInt(json.note[0].replace('/api/v1/note/','').replace('/',''));
            var curNote = app.makey.notes.get(noteId);

            json.note_body = curNote.get('body');
            this.$('#image_note_body').html(this.gallery_note(json));
            this.$('#image_note_row').show();
        }

        this.$('#main_video').hide();
        this.$('#main_image').show();

        this.$('#gallery-move-container').html(this.gallery_move_template({id: id, type: 'image'}));
        this.$('#image-remove-container').html(this.image_remove_template({id: id, type: 'image'}));

        var isCoverPic = false;
        if(curImage.get('resource_uri') === app.makey.get('cover_pic'))
            isCoverPic = true;

        this.updateCoverPicButton(true, isCoverPic, id);

        if(cur_user_details.id) {
            user_id = cur_user_details.id;
        } else {
            user_id = -1;
        }
        mixpanel.track("MakeyP: Event", {event_type: "makey_image_viewed", user_id:user_id, makey_id:{{makey_id}},
                                         image_id: id});

        this.renderPager("image", id);
        // delete(app.cur_image_id);
        this.$('#images_modal').modal('show');
        this.$el.find('.tooltips').tooltip();
    },

    getLikesString : function(json, type) {
        var likes_string = "Be the first one to like this " + type + "!";

        if(json.likes_count == 0) {
            return likes_string;
        }

        if(json.cur_user_likes) {
            likes_string = "You ";
            if(json.likes_count == 2) {
                likes_string += " and 1 other person ";
            } else if(json.likes_count > 2) {
                likes_string += " and " + (json.likes_count -1 ) + " others "
            }
            likes_string += "like this " + type + "!";
        } else {
            if(json.likes_count == 1) {
                likes_string = "1 person likes ";
            } else {
                likes_string = (json.likes_count) + " people like ";
            }
            likes_string += "this " + type + "!";
        }
        return likes_string;
    },

    showEditDescription : function() {
        this.$('#gallery_description_text').hide();
        this.$('#edit_gallery_description').show();

        this.$('#edit_description').hide();
        this.$('#cancel_edit_description').show();
    },

    cancelEditDescription : function() {
        this.$('#gallery_description_text').show();
        this.$('#edit_gallery_description').hide();

        this.$('#edit_description').show();
        this.$('#cancel_edit_description').hide();
    },

    saveDescription : function() {
        var description = this.$('#img_description')[0].value;
        var imgId = this.$('#img_description')[0].getAttribute('imgId').split('_');

        if(imgId[0] == "video") {
            var curVideo = app.makey.videos.get(parseInt(imgId[1]));
            curVideo.set({'description' : description});
            curVideo.save(curVideo.unsavedAttributes(), {
                patch : true,
            });

            mixpanel.track("MakeyP: Event", {event_type: "makey_video_description_edited", user_id:cur_user_details.id, makey_id:{{makey_id}}, video_id: imgId[1]});

            app.cur_video_id = parseInt(imgId[1]);
            this.cancelEditDescription();
        } else {
            var curImage = app.makey.images.get(parseInt(imgId[1]));
            curImage.set({'description' : description});
            curImage.save(curImage.unsavedAttributes(), {
                patch : true,
            });

            mixpanel.track("MakeyP: Event", {event_type: "makey_image_description_edited", user_id:cur_user_details.id, makey_id:{{makey_id}}, image_id: imgId[1]});

            app.cur_image_id = parseInt(imgId[1]);
            this.cancelEditDescription();
        }
    },

    clickVideo : function(event) {
        var video_id = parseInt(event.target.id.substring(4));
        this.showVideo(video_id);
        this.$('#images_modal').modal('show');

        $('#images_modal').on('hidden.bs.modal', function (e) {
            $('#main_video').find('iframe').attr('src', '');
        });
    },

    showVideo : function(id) {
        var curVideo = app.makey.videos.get(id);
        if(curVideo === undefined || curVideo.get('embed_url') === undefined) {
            return;
        }

        this.$('#main_video').find('iframe').attr('src', curVideo.get('embed_url'));

        var json = {'id' : id, 'comments' : curVideo.comments.toJSON(), 'type' : 'vid'};
        this.$('#gallery_comments_list').html(this.gallery_comments(json));

        json = curVideo.toJSON();
        json.likes_string = this.getLikesString(json, "video");
        json.type = "video"
        this.$('#gallery_like').html(this.gallery_like(json));

        json.can_edit = app.can_edit;
        this.$('#gallery_description').html(this.gallery_description(json));

        this.$('#gallery-move-container').html(this.gallery_move_template({id: id, type: 'video'}));
        this.$('#image-remove-container').html(this.image_remove_template({id: id, type: 'video'}));
        this.updateCoverPicButton(false, false, -1);

        this.$('#main_video').show();
        this.$('#main_image').hide();

        if(cur_user_details.id) {
            user_id = cur_user_details.id;
        } else {
            user_id = -1;
        }
        mixpanel.track("MakeyP: Event", {event_type: "makey_video_viewed", user_id:user_id, makey_id:{{makey_id}},
                                         video_id: id});

        this.renderPager("video", id);
        this.$('#images_modal').modal('show');
        this.$el.find('.tooltips').tooltip();
        // delete(app.cur_video_id);
    },

    renderPager : function(type, id) {
        var pager_details = {'prev_class' : "", 'next_class' : "", 'prev_content' : "", 'next_content' : ""};
        if(type == "image") {
            var prev_id = this.getPrevImg(id);
            if(prev_id == -1) {
                var prev_vid = app.makey.videos.last();
                if(prev_vid === undefined) {
                    pager_details.prev_class = "disabled";
                    pager_details.prev_content = "";
                } else {
                    pager_details.prev_class = "";
                    pager_details.prev_content = "vid_" + prev_vid.get('id');
                }
            } else {
                pager_details.prev_class = "";
                pager_details.prev_content = "img_" + prev_id;
            }

            var next_id = this.getNextImg(id);
            if(next_id == -1) {
                pager_details.next_class = "disabled";
                pager_details.next_content = "";
            } else {
                pager_details.next_class = "";
                pager_details.next_content = "img_" + next_id;
            }
        } else if(type == "video") {
            var prev_id = this.getPrevVid(id);
            if(prev_id == -1) {
                pager_details.prev_class = "disabled";
                pager_details.prev_content = "";
            } else {
                pager_details.prev_class = "";
                pager_details.prev_content = "vid_" + prev_id;
            }

            var next_id = this.getNextVid(id);
            if(next_id == -1) {
                var next_img = app.makey.images.first();
                if(next_img === undefined) {
                    pager_details.next_class = "disabled";
                    pager_details.next_content = "";
                } else {
                    pager_details.next_class = "";
                    pager_details.next_content = "img_" + next_img.get('id');
                }
            } else {
                pager_details.next_class = "";
                pager_details.next_content = "vid_" + next_id;
            }
        }

        this.$('#gallery_pager').html('')
        this.$('#gallery_pager').append(this.gallery_pager(pager_details));
    },

    getPrevImg : function(id) {
        var images = app.makey.images;
        var cur_img_pos = images.indexOf(images.get(id));

        if(cur_img_pos == 0) {
            return -1;
        } else {
            return images.at(cur_img_pos-1).get('id');
        }
    },

    getNextImg : function(id) {
        var images = app.makey.images;
        var cur_img_pos = images.indexOf(images.get(id));

        var next_img = images.at(cur_img_pos+1);
        if(next_img === undefined) {
            return -1;
        } else {
            return next_img.get('id');
        }
    },

    getPrevVid : function(id) {
        var videos = app.makey.videos;
        var cur_vid_pos = videos.indexOf(videos.get(id));

        if(cur_vid_pos == 0) {
            return -1;
        } else {
            return videos.at(cur_vid_pos-1).get('id');
        }
    },

    getNextVid : function(id) {
        var videos = app.makey.videos;
        var cur_vid_pos = videos.indexOf(videos.get(id));

        var next_vid = videos.at(cur_vid_pos+1);
        if(next_vid === undefined) {
            return -1;
        } else {
            return next_vid.get('id');
        }
    },

    galleryBrowse : function(event) {
        var details = event.target.id.split('_');
        var type = details[0];
        var id = parseInt(details[1]);

        if(type == "vid") {
            this.showVideo(id);
        } else if(type="img") {
            this.showImage(id);
        }
    },

    saveReorderImages : function() {
        var images_list = this.$('#reorder_images_list :input');

        for(var i=0; i<images_list.length; i++) {
            var img_id = parseInt(images_list[i].id.substring(10));
            var order = parseInt(images_list[i].value);

            var curImage = app.makey.images.get(img_id);
            curImage.set({'order' : order});
            curImage.save(curImage.unsavedAttributes(), {
                patch : true,
            });

        }
        mixpanel.track("MakeyP: Event", {event_type: "makey_images_reordered", user_id:cur_user_details.id, makey_id:{{makey_id}}});
    },

    saveReorderVideos : function() {
        var videos_list = this.$('#reorder_videos_list :input');

        for(var i=0; i<videos_list.length; i++) {
            var vid_id = parseInt(videos_list[i].id.substring(10));
            var order = parseInt(videos_list[i].value);

            var curVideo = app.makey.videos.get(vid_id);
            curVideo.set({'order' : order});
            curVideo.save(curVideo.unsavedAttributes(), {
                patch : true,
            });
        }

        mixpanel.track("MakeyP: Event", {event_type: "makey_videos_reordered", user_id:cur_user_details.id, makey_id:{{makey_id}}});
    },

    showReorderImages : function() {
        this.$('.image_sub').hide();
        this.$('#reorder_images_div').show();
    },

    showReorderVideos : function() {
        this.$('.image_sub').hide();
        this.$('#reorder_videos_div').show();
    },

    closeEditModal : function() {
        this.$('#img_url').val('');
        this.$('#vid_url').val('');

        this.$('.image_sub').hide();

        this.$('#failed_add').hide();
        this.$('#success_add').hide();
        this.$('#error_add').hide();
        this.$('#waiting_add').hide();
    },

    saveNewImage: function(url, processType) {
        var img = new app.Image({'large_url' : url});

        var that = this;
        this.$('#success_add_v2').hide();
        this.$('#waiting_add_v2').show();
        img.save(null, {
            success : function(model, response) {
                that.$('#waiting_add_v2').hide();
                that.$('#success_add_v2').show();
                app.makey.images.add(model);
                app.makey.get('images').push(model.get('resource_uri'));
                app.makey.save({
                    'images': app.makey.get('images'),
                },{
                    patch : true,
                });

                if(processType == "link"){
                    that.$('#img_url').val('');
                } else if (processType == "upload"){
                    that.clearImageUpload();
                }

                that.hideAddModal();

                mixpanel.track("MakeyP: Event", {event_type: "makey_image_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 image_id: model.get('id')});
            },
            error : function(model, response) {
                that.$('#waiting_add_v2').hide();
                that.$('#error_add_v2').show();

                that.$('#img_url_v2').val('');
            },
        });
    },

    clearImageUpload: function(){
        this.$('#up_images_v2').wrap('<form>').closest('form').get(0).reset();
        this.$('#up_images_v2').unwrap();
    },

    createNewImage : function() {
        var url_regex = /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_]*)?\??(?:[\-\+=&;%@\.\w_]*)#?(?:[\.\!\/\\\w]*))?)/;
        var url = this.$('#img_url_v2').val();

        if(!url) {
            this.$('#img_url_v2').notify(
                "URL is mandatory!",
                { position:"left" }
            );
            return;
        }

        if(!url_regex.test(url)) {
            this.$('#img_url_v2').notify(
                "Invalid URL!",
                { position:"left" }
            );
            return;
        }

        if(url.substring(4,0) != "http") {
            url = "http://" + url;
        }

        this.saveNewImage(url, 'link');
    },

    createNewVideo : function() {
        var youtube_url_regex = /^(http|https):\/\/(?:www\.)?youtube.com\/watch\?(?=[^?]*v=\w+)(?:[^\s?]+)?$/;
        var vimeo_url_regex = /^(http\:\/\/|https\:\/\/)?(www\.)?(vimeo\.com\/)([0-9]+)$/;

        var url = this.$('#vid_url_v2').val();

        var cur_site = 0;
        if(youtube_url_regex.test(url)) {
            cur_site = 6;
        } else if(vimeo_url_regex.test(url)) {
            cur_site = 4;
        } else {
            this.$('#vid_url_v2').notify(
                "Invalid URL!",
                { position:"left" }
            );
            return;
        }

        if(url.substring(4,0) != "http") {
            url = "http://" + url;
        }

        var vid = new app.Video({'url' : url, 'site' : cur_site});

        var that = this;
        this.$('#success_add_vid_v2').hide();
        this.$('#waiting_add_vid_v2').show();
        vid.save(null, {
            success : function(model, response) {
                that.$('#waiting_add_vid_v2').hide();
                that.$('#success_add_vid_v2').show();
                app.makey.videos.add(model);
                app.makey.get('videos').push(model.get('resource_uri'));
                app.makey.save({
                    'videos': app.makey.get('videos'),
                }, {
                    patch : true,
                });

                that.$('#vid_url_v2').val('');

                mixpanel.track("MakeyP: Event", {event_type: "makey_video_added", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                 video_id: model.get('id')});

                that.hideAddModal();
            },
            error : function(model, response) {
                that.$('#waiting_add_vid_v2').hide();
                that.$('#error_add_vid_v2').show();

                that.$('#vid_url_v2').val('');
            },
        });
    },

    deleteImage : function(event) {

        var that = this;

        var $btnEl = $(event.target);
        var img_id = $btnEl.data('id');

        var img = app.makey.images.get(img_id);

        img.save({'is_enabled':false}, {
            success: function(){
                var index = app.makey.get('images').indexOf(img.get('resource_uri'));
                app.makey.get('images').splice(index, 1);

                app.makey.save({
                    'images': app.makey.get('images'),
                }, {
                    patch : true,
                    success : function(model, response) {
                        mixpanel.track("MakeyP: Event", {
                            event_type: "makey_image_deleted",
                            user_id: cur_user_details.id,
                            makey_id: {{makey_id}},
                            image_id: img_id
                        });
                    },
                });
            },
        });

        app.makey.images.remove(img);
        this.hideImage();
    },

    deleteVideo : function(event) {
        var that = this;

        var $btnEl = $(event.target);
        var vid_id = $btnEl.data('id');
        var vid = app.makey.videos.get(vid_id);

        vid.save({'is_enabled':false},{
            success: function(){
                var index = app.makey.get('videos').indexOf(vid.get('resource_uri'));
                app.makey.get('videos').splice(index, 1);

                app.makey.save({
                    'videos': app.makey.get('videos'),
                }, {
                    patch : true,
                    success : function(model, response) {
                        mixpanel.track("MakeyP: Event", {
                            event_type: "makey_video_deleted",
                            user_id: cur_user_details.id,
                            makey_id: {{makey_id}},
                            video_id: vid_id
                        });
                    },
                });
            },
        });

        app.makey.videos.remove(vid);
        this.hideImage();
    },

    likeImage : function(event) {
        if(cur_user_details.id === undefined) {
            $('#login_modal').modal('show');
            return;
        }

        var btn_details = event.target.id.split('_');
        var imageId = parseInt(btn_details[1]);
        var likeId = parseInt(btn_details[2]);

        var curImage = app.makey.images.get(imageId);

        if(likeId == 0) {
            var newLike = new app.ImageLike({
                'image' : curImage.get('resource_uri'),
                'liker' : app.cur_fb_user,
            });
            newLike.save(null, {
                success : function(model, response) {
                    app.cur_image_id = imageId;
                    curImage.set({
                        'cur_user_likes' : true,
                        'like_id' : model.get('id'),
                        'likes_count' : parseInt(curImage.get('likes_count'))+1,
                    });
                    _cio.track("imageLikes",{makey_id:'{{makey_id}}',image_id:imageId});

                    for(var i=0; i<app.makey.collaborators.length; i++) {
                        var collab = app.makey.collaborators.models[i];
                        var mail = new app.SendMail({
                            'to': collab.get('email'),
                            'to_name': collab.get('first_name'),
                            'mail_type': 2,
                            'actor_id': cur_user_details.id,
                            'target_id': imageId,
                        });
                        mail.save();
                    }

                    mixpanel.track("MakeyP: Event", {event_type: "makey_image_liked", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                     image_id: imageId});
                },
            });
        } else {
            var newLike = new app.ImageLike({
                'id' : likeId,
            });
            newLike.destroy();
            app.cur_image_id = imageId;
            curImage.set({
                'cur_user_likes' : false,
                'like_id' : 0,
                'likes_count' : parseInt(curImage.get('likes_count'))-1,
            });

            mixpanel.track("MakeyP: Event", {event_type: "makey_image_unliked", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                             image_id: imageId});
        }
    },

    likeVideo : function(event) {
        if(cur_user_details.id === undefined) {
            $('#login_modal').modal('show');
            return;
        }

        var btn_details = event.target.id.split('_');
        var videoId = parseInt(btn_details[1]);
        var likeId = parseInt(btn_details[2]);

        var curVideo = app.makey.videos.get(videoId);

        if(likeId == 0) {
            var newLike = new app.VideoLike({
                'video' : curVideo.get('resource_uri'),
                'liker' : app.cur_fb_user,
            });
            newLike.save(null, {
                success : function(model, response) {
                    app.cur_video_id = videoId;
                    curVideo.set({
                        'cur_user_likes' : true,
                        'like_id' : model.get('id'),
                        'likes_count' : parseInt(curVideo.get('likes_count'))+1,
                    });
                    _cio.track("videoLikes",{makey_id:'{{makey_id}}',video_id:videoId});

                    for(var i=0; i<app.makey.collaborators.length; i++) {
                        var collab = app.makey.collaborators.models[i];
                        var mail = new app.SendMail({
                            'to': collab.get('email'),
                            'to_name': collab.get('first_name'),
                            'mail_type': 3,
                            'actor_id': cur_user_details.id,
                            'target_id': videoId,
                        });
                        mail.save();
                    }

                    mixpanel.track("MakeyP: Event", {event_type: "makey_video_liked", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                                     video_id: videoId});
                },
            });
        } else {
            var newLike = new app.VideoLike({
                'id' : likeId,
            });
            newLike.destroy();
            app.cur_video_id = videoId;
            curVideo.set({
                'cur_user_likes' : false,
                'like_id' : 0,
                'likes_count' : parseInt(curVideo.get('likes_count'))-1,
            });

            mixpanel.track("MakeyP: Event", {event_type: "makey_video_unliked", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                             video_id: videoId});
        }
    },

    uploadImagesPreview : function(event) {
        var that = this;
        var s3upload = new S3Upload({
            file_dom_selector: 'up_images_v2',
            s3_sign_put_url: "{% url 'catalog:sign_image_s3' %}",
            onProgress: function(percent, message) {
                var progress = percent + '%';
                that.$('#progress_bar_v2').show();
                that.$('#progress_bar_v2 .progress-bar').css('width', progress).html(progress);
                // status_elem.innerHTML = 'Upload progress: ' + percent + '% ' + message;
            },
            onFinishS3Put: function(url) {
                that.options.upload_retries = 0;

                that.$('#upload_error_v2_retry').hide();
                that.$('#upload_error_v2').hide();
                that.$('#upload_img_url_v2').val(url);
                var json = {
                    source: url,
                    title: 'temp_image',
                }
                that.uploadImages();
            },
            onError: function(status) {
                that.$('#out_images').html('');
                that.$('#progress_bar_v2').hide();


                that.options.upload_retries++;
                if(that.options.upload_retries <= 3) {
                    that.uploadImagesPreview(event);
                    that.$('#upload_error_v2_retry').show();
                } else {
                    that.options.upload_retries = 0;
                    that.$('#upload_error_v2_retry').hide();
                    that.$('#upload_error_v2').show();
                    that.clearImageUpload();
                }
            }
        });
    },

    uploadImages : function() {
        var url = this.$('#upload_img_url_v2').val();
        this.saveNewImage(url, 'upload');
        this.$('#progress_bar_v2').hide();
    },
});

app.MakeySuggestionsView = Backbone.View.extend({
    el : $('#makey_list'),
    template : Handlebars.compile($('#makey_suggestions_template').html()),

    events : {
        'click .suggested_makey' : 'clickSuggestion',
    },

    initialize : function() {
        this.listenTo(app.makey.similar, 'add', this.addAll);
        this.listenTo(app.makey.similar, 'remove', this.addAll);
        this.listenTo(app.makey.similar, 'change', this.addAll);
    },

    addAll : function() {
        this.$el.html('');
        app.makey.similar.each(this.add, this);
        this.$el.find('.tooltips').tooltip();
    },

    add : function(model) {
        this.$el.append(this.template(model.toJSON()));
        return this;
    },

    clickSuggestion : function(event) {
        var suggestion_id = parseInt(event.target.getAttribute('href').substring(7));

        mixpanel.track("MakeyP: Event", {event_type: "makey_suggestion_clicked", user_id:cur_user_details.id, makey_id:{{makey_id}},
                                         suggestion_id: suggestion_id, position: app.makey.similar.indexOf(app.makey.similar.get(suggestion_id))});
    }
});

app.MakeyDerivedView = Backbone.View.extend({
    el: '#derived',

    module_template: Handlebars.compile($('#makey_module_template').html()),

    events: {
        'click #search_derived': 'searchDerived',
        'click #save_derived': 'saveDerived',
        'click #cancel_derived': 'cancelDerived',
    },

    initialize: function(){
        this.listenTo(app.makey, 'change:derived_from', this.add);
        var that = this;
        var makeys = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                remote: {
                    url: '/api/v1/makey/search?q=%QUERY',
                        filter: function(list) {
                            return $.map(list.makeys, function(makey) {
                                return { name: makey.name,
                                         id: "/api/v1/makey/" + makey.id + "/",
                                         user_name: makey.user.first_name + " " + makey.user.last_name };
                            });
                        },
                        ajax: {
                            beforeSend: function() {
                                that.showSearchLoading();
                            },
                            complete: function() {
                                that.hideSearchLoading();
                            }
                        }
                },
                limit: 10
        });
        makeys.initialize();

        this.$('#edit-derived-input').typeahead({
            hint: true,
            highlight: true,
            minLength: 1
        },
        {
            name: 'makeys',
            displayKey: 'name',
            source: makeys.ttAdapter(),
            templates: {
                empty: Handlebars.compile($('#tt-makey-suggestion-empty-template').html()),
                suggestion: Handlebars.compile($('#tt-makey-suggestion-template').html())
            }
        });

        var that = this;
        this.$('#edit-derived-input').on("typeahead:selected", function(event, selected, dataset){
            that.saveDerived(selected.id);
        });

    },

    showSearchLoading: function() {
        this.$('.tt-hint').css('background-image', 'url("{% static 'images/ajax-loader.gif' %}")');
        this.$('.tt-hint').css('background-position', 'right center');
        this.$('.tt-hint').css('background-repeat', 'no-repeat');
    },

    hideSearchLoading: function() {
        this.$('.tt-hint').css('background-image', '');
    },

    add: function() {
        if(app.makey.get('derived_from') === null){
            return;
        }

        var fromMakey = new app.MakeyBasic({
            "resource_uri": app.makey.get('derived_from').replace('makey', 'top_makeys')
        });

        var that = this;
        fromMakey.fetch({
            success: function(model, response){
                var makey_details = that.fetchMakeyDetails(response);

                that.addMain(makey_details);
            }
        });
    },

    fetchMakeyDetails: function(json){
        var details = {};
        details['name'] = json.name;
        details['url'] = '/makey/' + json.id + '/';

        var img_url = "";
        if(json.cover_pic !== null){
            var cover_pic = json.cover_pic;
            if(cover_pic.small_url !== null) {
                img_url = cover_pic.small_url;
            } else {
                img_url = cover_pic.large_url;
            }
        } else if(json.images.length > 0){
            var first_img = json.images[0];
            if(first_img.small_url !== null) {
                img_url = first_img.small_url;
            } else {
                img_url = first_img.large_url;
            }
        } else {
            {% load static %}
            img_url = "{% static 'images/tools.jpg' %}";
        }

        details['img_url'] = img_url;
        return details;
    },

    addMain: function(makey_details){
        this.$('#makey_derived').html('');
        this.$('#makey_derived').append(this.module_template({
            'makey_name': makey_details['name'],
            'makey_url': makey_details['url'],
            'makey_img_url': makey_details['img_url'],
        }));
        return;
    },

    saveDerived: function(makey){
        app.makey.save({
            'derived_from': makey,
        }, {
            patch: true,
        });

        this.resetInput();
    },

    resetInput: function() {
        this.$('#edit-derived-input').typeahead('val', '');
    }
});


app.MakeyAsPartView = Backbone.View.extend({
    el: '#as_part',

    module_template: Handlebars.compile($('#makey_parts_template').html()),
    new_part_template: Handlebars.compile($('#makey_new_part_template').html()),

    events: {
        'click #search_as_part': 'searchPart',
        'click #save_as_part': 'savePart',
        'click #cancel_as_part': 'cancelPart',
        'click #btn_add_new_part': 'showNewPartForm',
        'click #btn_cancel_new_parts': 'hideNewPartForm',
        'click #btn_submit_new_parts': 'saveNewPart',
        'click .new-part-delete-btn': 'removeAsPart',
        'click .part-delete-btn': 'removeAsPart',
    },

    initialize: function(){
        this.listenTo(app.makey, 'change:as_part', this.add);
        this.listenTo(app.makey, 'change:as_part_new', this.add);

        var that = this;
        var products = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
                url: '/api/v1/product/search?q=%QUERY',
                    filter: function(list) {
                        return $.map(list.products, function(product) {
                            return { name: product.name, id: product.id };
                        });
                    },
                    ajax: {
                        beforeSend: function() {
                            that.showSearchLoading();
                        },
                        complete: function() {
                            that.hideSearchLoading();
                        }
                    }
            },
            limit: 10
        });
        products.initialize();

        this.$('#edit-as-part-input').typeahead({
            hint: true,
            highlight: true,
            minLength: 1
        },{
            name: 'products',
            displayKey: 'name',
            source: products.ttAdapter(),
            templates: {
                empty: Handlebars.compile($('#tt-part-suggestion-empty-template').html()),
                footer: Handlebars.compile($('#tt-part-suggestion-footer-template').html()),
            }
        });

        var that = this;
        this.$('#edit-as-part-input').on("typeahead:selected", function(event, selected, dataset){
            that.savePart(selected.id);
        });
    },

    showSearchLoading: function() {
        this.$('.tt-hint').css('background-image', 'url("{% static 'images/ajax-loader.gif' %}")');
        this.$('.tt-hint').css('background-position', 'right center');
        this.$('.tt-hint').css('background-repeat', 'no-repeat');
    },

    hideSearchLoading: function() {
        this.$('.tt-hint').css('background-image', '');
    },

    add: function() {
        if(app.makey.get('as_part')){
            var part = new app.Part({
                "resource_uri": app.makey.get('as_part'),
            });

            var that = this;
            part.fetch({
                success: function(model, response){

                    that.addMain(response);
                }
            });
            return;
        }

        if(app.makey.get('as_part_new')){
            var newpart = new app.NewPart({
                "resource_uri": app.makey.get('as_part_new'),
            });

            var that = this;
            newpart.fetch({
                success: function(model, response){

                    that.addMainNew(response);
                }
            });
            return;
        }

        this.addEmpty();
    },

    fetchMakeyDetails: function(json){
        var details = {};
        details['name'] = json.name;
        details['url'] = '/makey/' + json.id + '/';

        var img_url = "";
        if(json.cover_pic !== null){
            var cover_pic = json.cover_pic;
            if(cover_pic.small_url !== null) {
                img_url = cover_pic.small_url;
            } else {
                img_url = cover_pic.large_url;
            }
        } else if(json.images.length > 0){
            var first_img = json.images[0];
            if(first_img.small_url !== null) {
                img_url = first_img.small_url;
            } else {
                img_url = first_img.large_url;
            }
        } else {
            {% load static %}
            img_url = "{% static 'images/tools.jpg' %}";
        }

        details['img_url'] = img_url;
        return details;
    },

    addMain: function(json){
        this.$('#makey_as_part').html('');
        this.$('#makey_as_part').append(this.module_template(json));
        return;
    },

    addEmpty: function(json){
        this.$('#makey_as_part').html('<p>Not set yet.</p>');
        return;
    },

    addMainNew: function(json){
        this.$('#makey_as_part').html('');
        this.$('#makey_as_part').append(this.new_part_template(json));
        return;
    },

    savePart: function(part_id){
        NProgress.start();
        app.makey.save({
            'as_part': '/api/v1/product/' + part_id + '/',
            'as_part_new': ''
        }, {
            patch: true,
            success: function() {
                NProgress.done();
            }
        });

        this.resetInput();
    },

    resetInput: function() {
        this.$('#edit-as-part-input').typeahead('val', '');
    },


    showNewPartForm: function() {
        this.$('#edit-as-part-input').typeahead('close');
        this.$('#edit-as-part-input').typeahead('val', '');
        this.$("#new_part_form").slideDown();
        this.$('#new_as_part_name').focus();
    },

    hideNewPartForm: function() {
        this.$("#new_part_form").slideUp();
        this.$('#new_as_part_name').val('');
        this.$('#new_as_part_url').val('');
        this.$('#edit-as-part-input').focus();
    },

    saveNewPart: function() {
        var new_as_part_name = $('#new_as_part_name').val();
        var new_as_part_url = $('#new_as_part_url').val();

        if(new_as_part_name == "" || new_as_part_url == "") {
            if(new_as_part_name == "") {
                this.$('#new_as_part_name').select();
            } else {
                this.$('#new_as_part_url').select();
            }
            return;
        }

        var url_regex = /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_]*)?\??(?:[\-\+=&;%@\.\w_]*)#?(?:[\.\!\/\\\w]*))?)/;
        if(!url_regex.test(new_as_part_url)) {
            this.$('#new_as_part_url').select();
            return;
        }

        var part = new app.NewPart({
            'name' : new_as_part_name,
            'url' : new_as_part_url,
        });

        var that = this;
        NProgress.start();
        part.save(null, {
            success : function(model, response) {
                NProgress.set(0.5);
                app.makey.save({
                    'as_part_new': model.get('resource_uri'),
                    'as_part': ''
                }, {
                    patch : true,
                    success: function() {
                        NProgress.done();
                    }
                });
            },
        });

        this.hideNewPartForm();
    },

    removeAsPart: function() {
        NProgress.start();
        app.makey.save({
            'as_part_new': '',
            'as_part': ''
        }, {
            patch : true,
            success: function() {
                NProgress.done();
            }
        });
    }
});

app.MakeyLikesView = Backbone.View.extend({
    el : '#likes_info',
    template : Handlebars.compile($('#like_template').html()),
    liker_template : Handlebars.compile($('#liker_template').html()),

    options : {
        'likes_string' : "Be the first one to like this!",
        'all_likes_loaded' : false,
    },

    events : {
        'click .like_makey' : 'clickLike',
        'click .btn' : 'checkLogin',
        'click .likes_string' : 'showAllLikers',
    },

    initialize : function() {
        this.listenTo(app.likes, 'add', this.loadCurUserLikeStatus);
        this.listenTo(app.likes, 'change', this.loadCurUserLikeStatus);
        this.listenTo(app.likes, 'reset', this.loadCurUserLikeStatus);
        this.listenTo(app.likes, 'fetch', this.loadCurUserLikeStatus);

        this.loadCurUserLikeStatus();
        this.loadAllLikes();
    },

    loadAllLikes : function() {
        var allLikes = new app.MakeyLikeList({allLikes : true});
        allLikes.fetch({
            success : function(collection, response) {
                app.allLikes = collection;
            }
        });
    },

    testloadLikesString : function() {
        var that = this;
        app.likes.fetch({
            success : function(model, response) {
                that.loadLikesString();
            },
        });
    },

    loadCurUserLikeStatus : function() {
        if(cur_user_details.id === undefined) {
            this.options.curUserLikes = false;
            this.options.like_id = 0;
            this.loadLikesString();
            return;
        }

        var userLikes = new app.MakeyLikeList({'curUserLikes' : true});

        var that = this;
        userLikes.fetch({
            success : function(collection, response) {
                if(collection.meta.total_count != 0) {
                    that.options.curUserLikes = true;
                    that.options.userLike = collection.models[0];
                    app.likes.push(collection.models[0]);
                    that.options.like_id = collection.models[0].id;
                } else {
                    that.options.curUserLikes = false;
                    that.options.like_id = 0;
                }
                that.loadLikesString();
            },
        });
    },

    loadLikesString : function() {
        // if(this.options.total_likes ==== undefined || isNaN(this.options.total_likes)) {
            this.options.total_likes = parseInt(app.likes.meta.total_count);
        // }
        var total_likes = this.options.total_likes;

        if(isNaN(total_likes) || total_likes == 0 || app.likes.models[0] === undefined || app.likes.models[0].get('liker') === undefined) {
            this.options.likes_string = "Be the first one to like this!";

        } else {
            var likes_string = this.options.likes_string;
            if(this.options.curUserLikes) {
                likes_string = "You ";

                if(total_likes == 1) {
                } else if(total_likes == 2) {
                    likes_string += "and ";
                    if(app.likes.models[0].get('liker').id == cur_user_details.id) {
                        likes_string += app.likes.models[1].get('liker').first_name + " ";
                    } else {
                        likes_string += app.likes.models[0].get('liker').first_name + " ";
                    }
                } else {
                    likes_string += ", "
                    if(app.likes.models[0].get('liker').id == cur_user_details.id) {
                        likes_string += app.likes.models[1].get('liker').first_name + " ";
                    } else {
                        likes_string += app.likes.models[0].get('liker').first_name + " ";
                    }
                    likes_string += "and " + (total_likes-2) + " others "
                }

                likes_string +=  "like this!";
            } else {
                likes_string = "";

                if(total_likes == 1) {
                    likes_string += app.likes.models[0].get('liker').first_name + " ";
                    likes_string += "likes this!";
                } else if(total_likes == 2) {
                    likes_string += app.likes.models[1].get('liker').first_name + " ";
                    likes_string += "and ";
                    likes_string += app.likes.models[0].get('liker').first_name + " ";
                    likes_string +=  "like this!";
                } else {
                    likes_string += app.likes.models[1].get('liker').first_name + " ";
                    likes_string += ", ";
                    likes_string += app.likes.models[0].get('liker').first_name + " ";
                    likes_string += "and " + (total_likes-2) + " others "
                    likes_string +=  "like this!";
                }
            }
            this.options.likes_string = likes_string;
        }
        this.addAll();
    },

    addAll : function() {
        this.$('#likes').html('');

        var like_btn_cls = "btn-info";
        var like_status = "Like";
        if(this.options.curUserLikes) {
            like_btn_cls = "btn-success";
            like_status = "Liked";
        }

        this.$('#likes').append(
            this.template({
                'like_id' : this.options.like_id,
                'like_btn_cls' : like_btn_cls,
                'like_status' : like_status,
                'likes_string' : this.options.likes_string,
            })
        );
    },

    clickLike : function(event) {
        if(cur_user_details.id === undefined) {
            $('#login_modal').modal('show');
            return;
        }
        this.$('.btn').attr("disabled", true);
        var like_id = parseInt(event.target.id.substring(5));

        if(like_id == 0) {
            var newLike = new app.MakeyLike({
                'liker' : app.cur_fb_user,
            });

            var that = this;
            newLike.save(null, {
                success : function(model, response) {
                    that.options.curUserLikes = true;
                    that.options.like_id = response.id;

                    app.likes.fetch({
                        success : function() {
                            that.testloadLikesString();
                        },
                    });
                    _cio.track("makeyLikes",{makey_id:'{{makey_id}}'});

                    for(var i=0; i<app.makey.collaborators.length; i++) {
                        var collab = app.makey.collaborators.models[i];
                        var mail = new app.SendMail({
                            'to': collab.get('email'),
                            'to_name': collab.get('first_name'),
                            'mail_type': 1,
                            'actor_id': cur_user_details.id,
                            'target_id': {{makey_id}},
                        });
                        mail.save();
                    }

                    FB.api('me/og.likes', 'post', {
                        object: "http://www.makeystreet.com/makey/{{makey_id}}/"
                    }, function(response) {
                        if(response.error === undefined) {
                            newLike.save({'fb_like_id': response.id}, {
                                patch: true,
                                success: function(model, response) {
                                    that.options.userLike = model;
                                }
                            });
                        }
                    });

                    mixpanel.track("MakeyP: Event", {event_type: "makey_liked", user_id:cur_user_details.id, makey_id:{{makey_id}}});
                },
            });
        } else {
            var curLike = this.options.userLike;
            var fb_like_id = curLike.get('fb_like_id');

            var that = this;
            curLike.destroy({
                success : function() {
                    that.options.curUserLikes = false;
                    that.options.like_id = 0;

                    that.testloadLikesString();

                    FB.api(fb_like_id, 'delete', function(response) {
                    });
                    mixpanel.track("MakeyP: Event", {event_type: "makey_unliked", user_id:cur_user_details.id, makey_id:{{makey_id}}});
                },
            });
        }
    },

    showAllLikers : function() {
        if(app.allLikes === undefined) {
            var allLikes = new app.MakeyLikeList({allLikes : true});

            var that=this;
            allLikes.fetch({
                success : function(collection, response) {
                    var json = {'likes' : response};
                    that.$('.modal-body')[0].innerHTML = that.liker_template(json);
                    that.$('#all_likes_modal').modal('show');
                    app.allLikes = collection;
                },
            });
        } else {
            if(!this.options.all_likes_loaded) {
                var json = {'likes' : app.allLikes.toJSON()};
                this.$('.modal-body')[0].innerHTML = this.liker_template(json);
                this.options.all_likes_loaded = true;
            }
            this.$('#all_likes_modal').modal('show');
        }
    },
});

app.MakeyAccessView = Backbone.View.extend({
    el: '#makey-access-toggle',

    events: {
        'click #makey-type-public': 'makeyPublic',
        'click #makey-type-private': 'makeyPrivate',
    },

    initialize: function() {

    },

    makeyPublic: function() {
        this.updateButton(false);
        this.updateMakeyAccess(false);
    },

    makeyPrivate: function() {
        this.updateButton(true);
        this.updateMakeyAccess(true);
    },

    updateMakeyAccess: function(isPrivate) {
        if (app.makey.get('is_private') === isPrivate) {
            return;
        }

        var that = this;
        app.makey.save({'is_private' : isPrivate}, {
            patch: true,
            silent: true,
            success: function(model, response) {
                that.updateButton(model.get('is_private'));
            }
        });
    },

    updateButton: function(isPrivate) {
        if (isPrivate) {
            this.$("#makey-type-public").removeClass("active");
            this.$("#makey-type-private").addClass("active");
        } else {
            this.$("#makey-type-public").addClass("active");
            this.$("#makey-type-private").removeClass("active");
        }
    }

});

app.MakeyStepsView = Backbone.View.extend({
    el: '#steps',

    tabs_template: Handlebars.compile($('#steps-tabs-template').html()),
    content_template: Handlebars.compile($('#steps-content-template').html()),

    initialize : function() {
        this.listenTo(app.makey.steps, 'destroy', this.addAll);
        this.listenTo(app.makey.steps, 'change', this.addAll);
        this.listenTo(app.makey.steps, 'add', this.addAll);
        this.listenTo(app.makey.steps, 'remove', this.addAll);
        this.listenTo(app.makey.steps, 'reset', this.addAll);

        this.addAll();
    },

    addAll : function() {
        this.$('#steps-tabs').html('');
        this.$('#steps-content').html('');

        app.makey.steps.sort();
        app.makey.steps.each(this.add, this);

        if(app.makey.steps.length > 0) {
            this.$('#steps-tabs').show();
            this.$('#steps-content').show();
        } else {
            this.$('#steps-tabs').hide();
            this.$('#steps-content').hide();
        }

        this.$el.find('.tooltips').tooltip();
    },

    add: function(model) {
        if(model.get('id') === undefined) {
            return;
        }

        var json = model.toJSON();
        if(json.body!=undefined) {
            json.body = json.body.replace(/\n/g, "<br/>");
            json.body = Autolinker.link(json.body);
        }
        json.can_edit = app.can_edit;

        if(json.step == 1) {
            json.first = true;
        } else {
            json.first = false;
        }

        this.$('#steps-tabs').append(this.tabs_template(json));
        this.$('#steps-content').append(this.content_template(json));

        $('#step_' + json.id).click(function (e) {
            e.preventDefault();
            $(this).tab('show');
        });

        // Reorder Steps
    },
});


app.Tag = Backbone.Tastypie.Model.extend({
    urlRoot : '/api/v1/tag/',
    idAttribute : 'id',

    url : function() {
        if(this.get('resource_uri') !== undefined) {
            return this.get('resource_uri');
        } else if(this.get('id') !== undefined) {
            return this.urlRoot + this.get('id') + "/";
        } else {
            return this.urlRoot;
        }
    },

    initialize : function() {
        if(this.get('resource_uri') !== undefined) {
            this.fetch();
        }
    },
});

app.TagList = Backbone.Tastypie.Collection.extend({
    model : app.Tag,
    urlRoot : '/api/v1/tag/',

    url : function() {
        return this.urlRoot;
    },
});


app.MakeyTagsView = Backbone.View.extend({
    el: '#makey-tags',

    events: {
        'click #btn_add_new_tag': 'showNewTagForm',
        'click #tag-create-btn': 'createNewTag',
        'click #tag-create-cancel': 'hideNewTagForm',
        'click #save-tags': 'saveTags',
        'click #edit-tags-btn': 'showEditForm',
        'click #cancel-tags-edit': 'hideEditForm',
    },

    initialize : function() {
        this.listenTo(app.makey.tags, 'add', this.addAll);
        this.listenTo(app.makey.tags, 'reset', this.addAll);
        this.listenTo(app.makey.tags, 'destroy', this.addAll);
        this.listenTo(app.makey.tags, 'change', this.addAll);
        this.listenTo(app.makey.tags, 'remove', this.addAll);

        this.tagsEngine = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
                url: '/api/v1/tag/search/?q=%QUERY',
                filter: function(list) {
                    return $.map(list.tags, function(tag) {
                        return tag;
                    });
                }
            },
            limit: 20
        });
        this.tagsEngine.initialize();

        this.$('#makey-tags-input').tagsinput({
            itemText : 'name',
            itemValue : 'resource_uri',
            typeaheadjs: {
                hint: false,
                highlight: true,
                minLength: 1,
                name: 'tags',
                displayKey: 'name',
                source: this.tagsEngine.ttAdapter(),
                templates: {
                    empty: Handlebars.compile($('#tt-tags-suggestion-empty-template').html()),
                    footer: Handlebars.compile($('#tt-tags-suggestion-footer-template').html()),
                }
            }
        });

        this.$el.find('.tooltips').tooltip();
    },

    showEditForm: function() {
        this.$('#makey-tags-input').tagsinput('removeAll');
        for (var i = 0; i < app.makey.tags.length; i++) {
            var tag = app.makey.tags.models[i];
            this.$('#makey-tags-input').tagsinput('add', tag.attributes );
        }

        this.$('#makey-tags-input').tagsinput('refresh');

        this.hideTagsList();
        this.$("#tag-edit-form").show();
    },

    showTagsList: function() {
        this.addAll();
        this.$('#makey-tags-preview').show();
    },

    hideTagsList: function() {
        this.$('#makey-tags-preview').hide();
    },

    hideEditForm: function() {
        this.$("#tag-edit-form").hide();
        this.showTagsList();
    },

    addAll : function() {
        this.$("#makey-tags-list").empty();
        for (var i = 0; i < app.makey.tags.length; i++) {
            var tag = app.makey.tags.models[i];
            if(i == 0)
                this.$("#makey-tags-list").append(tag.get('name'));
            else
                this.$("#makey-tags-list").append(", " + tag.get('name'));
        }
        if(app.makey.tags.length == 0)
            this.$("#makey-tags-list").append("No tags added yet.");
    },

    showNewTagForm: function() {
        $(this.$('#makey-tags-input').tagsinput('input')).typeahead('close');
        $(this.$('#makey-tags-input').tagsinput('input')).typeahead('val', '');
        this.$("#tag-create-form").slideDown();
        this.$('#tag-create-input').focus();
    },

    hideNewTagForm: function() {
        this.$("#tag-create-form").slideUp();
        this.$("#tag-create-input").val('');
        this.$('#makey-tags-input').tagsinput('input').focus();
    },

    createNewTag: function() {
        var newTagName = this.$('#tag-create-input').val();
        if(!newTagName)
            return;

        var newTag = new app.Tag({
            'name': newTagName.toLowerCase(),
        });

        var that = this;
        newTag.save(null, {
            success : function(model, response) {
                that.addNewTag(model);
                that.hideNewTagForm();
                that.$('#makey-tags-input').tagsinput('focus');
            }
        });

        this.tagsEngine.clearRemoteCache();
    },

    addNewTag: function(newTag) {
        this.$('#makey-tags-input').tagsinput('add', newTag.attributes);
    },

    saveTags: function() {

        var tags = this.$('#makey-tags-input').tagsinput('items');
        var tagsClone = _.map(tags, _.clone);

        app.makey.set('tags', tagsClone);
        var that = this;
        this.$("#save-tags").html('Saving...');
        this.$("#save-tags").addClass('disabled');
        NProgress.start();
        app.makey.save({
            'tags': app.makey.get('tags')
        }, {
            patch : true,
            success: function() {
                NProgress.done();
                that.$("#save-tags").html('Save');
                that.$("#save-tags").removeClass('disabled');
                that.hideEditForm();
            }
        });
    }
});

app.MakeyFilesView = Backbone.View.extend({
    el: "#files",
    file_template: Handlebars.compile($('#makey_file_template').html()),

    events: {
        'change #add-file-input': 'getSignature',
        'click #btn-upload-file': 'handleUploadBtnClick',
    },

    options: {
        upload_retries: 0
    },

    initialize: function(){
        this.listenTo(app.makey.files, 'add', this.addAll);
        this.listenTo(app.makey.files, 'remove', this.addAll);
        this.listenTo(app.makey.files, 'reset', this.addAll);
        this.listenTo(app.makey.files, 'change', this.addAll);

        this.disableUploadBtn();
    },

    addAll: function() {
        this.$('#makey_files').html('');
        app.makey.files.each(this.add, this);
    },

    add: function(model) {
        this.$('#makey_files').append(this.file_template(model.toJSON()));
    },

    getSignature: function(event) {
        this.enableUploadBtn();
    },

    handleUploadBtnClick: function() {
        this.initiateFileUpload();
    },

    initiateFileUpload: function() {
        var that = this;
        var s3upload = new S3Upload({
            file_dom_selector: 'add-file-input',
            s3_sign_put_url: "{% url 'catalog:sign_file_s3' %}",
            s3_extra_parameters: "makey_id={{makey_id}}",
            onProgress: function(percent, message) {
                var progress = percent + '%';
                that.$('#progress_bar_v2').show();
                that.$('#progress_bar_v2 .progress-bar').css('width', progress).html(progress);
                // status_elem.innerHTML = 'Upload progress: ' + percent + '% ' + message;
            },
            onFinishS3Put: function(url) {
                that.options.upload_retries = 0;

                that.$('#upload_error_v2_retry').hide();
                that.$('#upload_error_v2').hide();
                that.$('#upload_file_url').val(url);

                that.uploadFile();
            },
            onError: function(status) {
                that.$('#progress_bar_v2').hide();

                that.options.upload_retries++;
                if(that.options.upload_retries <= 3) {
                    // that.getSignature(event);
                    that.initiateFileUpload();
                    that.$('#upload_error_v2_retry').show();
                } else {
                    that.options.upload_retries = 0;
                    that.$('#upload_error_v2_retry').hide();
                    that.$('#upload_error_v2').show();
                    that.clearFileUpload();
                }
            }
        });
    },

    hideDescriptionInput: function() {
        this.$('#add-file-desc-input').hide();
    },

    showDescriptionInput: function() {
        this.$('#add-file-desc-input').show();
    },

    clearFileUpload: function(){
        this.$('#add-file-input').wrap('<form>').closest('form').get(0).reset();
        this.$('#add-file-input').unwrap();
        this.disableUploadBtn();
    },

    disableUploadBtn: function() {
        this.$("#btn-upload-file").addClass("disabled");
        this.buttonEnabled = false;
        this.hideDescriptionInput();
    },

    enableUploadBtn: function() {
        this.$("#btn-upload-file").removeClass("disabled");
        this.buttonEnabled = true;
        this.showDescriptionInput();
    },

    uploadFile: function(){
        var url = this.$('#upload_file_url').val();
        var file = this.$('#add-file-input')[0].files[0];
        var description = this.$('#add-file-desc-input').val();

        var that = this;

        this.$('#success_add_v2').hide();
        this.$('#waiting_add_v2').show();

        for(var i=0; i<app.makey.files.length; i++) {
            if(app.makey.files.models[i].get('filename') == file.name) {
                app.makey.files.models[i].save({
                    'description': description,
                }, {
                    patch: true,
                    success: function(model, response) {
                        that.$('#waiting_add_v2').hide();
                        that.$('#success_add_v2').show();
                        that.clearFileUpload();
                    },
                    error: function(model, response) {
                        that.$('#waiting_add_v2').hide();
                        that.$('#error_add_v2').show();
                    }
                });
                this.$('#progress_bar_v2').hide();
                return;
            }
        }

        var f = new app.File({
            'filename': file.name,
            'filetype': file.type,
            'description': description,
            'url' : url
        });

        f.save(null, {
            success : function(model, response) {
                that.$('#waiting_add_v2').hide();
                that.$('#success_add_v2').show();
                app.makey.files.add(model);
                app.makey.get('files').push(model.get('resource_uri'));
                app.makey.save({
                    'files': app.makey.get('files'),
                },{
                    patch : true,
                });

                that.clearFileUpload();
            },
            error : function(model, response) {
                that.$('#waiting_add_v2').hide();
                that.$('#error_add_v2').show();
            },
        });
        this.$('#progress_bar_v2').hide();
    },
});

// Loading hashfragments
if(window.location.hash) {
    var hash = window.location.hash.split('/');
    if(hash[0] == "#image") {
        app.cur_image_id = parseInt(hash[1]);
    } else if(hash[0] == "#video") {
        app.cur_video_id = parseInt(hash[1]);
    } else if(hash[0] == "#note") {
        app.cur_note_id = parseInt(hash[1]);
    } else if(hash[0] == "#comment") {
        app.cur_comment_id = parseInt(hash[1]);
    }
}


//--------------
// Initializers
//--------------
app.makey = new app.Makey({'id':{{makey_id}}});
app.makey.fetch({
    success: function (model, response, options) {
        model.startTracking();
    }
});

app.likes = new app.MakeyLikeList();

app.makerpops = new app.MakerPopList();
app.partpops = new app.PartPopList();
app.toolpops = new app.PartPopList();

app.aboutView = new app.MakeyAboutView();
// app.creditsView = new app.MakeyCreditsView();
app.mentorsView = new app.MakeyMentorsView();
app.statusView = new app.MakeyStatusView();
// app.whyView = new app.MakeyWhyView();
// app.documentationView = new app.MakeyDocumentationView();
// app.documentationView = new app.MakeyDocumentationViewV2();
app.collaboratorsView = new app.MakeyCollaboratorsView();
app.partsView = new app.MakeyPartsView();
// app.toolsView = new app.MakeyToolsView();
// app.notesView = new app.MakeyNotesView();
app.notesView = new app.MakeyNotesViewV2();
app.docView = new app.MakeyTextDocumentationView();
app.imagesView = new app.MakeyImagesView();
app.infoView = new app.MakeyInfoView();
app.commentsView = new app.MakeyCommentsView();
// app.suggestionsView = new app.MakeySuggestionsView();
app.likesView = new app.MakeyLikesView();
app.derivedView = new app.MakeyDerivedView();
app.asPartView = new app.MakeyAsPartView();
app.accessView = new app.MakeyAccessView();
// app.stepsView = new app.MakeyStepsView();
app.tagsView = new app.MakeyTagsView();
app.filesView = new app.MakeyFilesView();

</script>
